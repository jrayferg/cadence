<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadence - Music Lesson Management</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'DM Sans', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Fraunces', serif;
    }

    :root {
      --color-primary: #0F766E;
      --color-primary-light: #14B8A6;
      --color-accent: #F59E0B;
      --color-bg: #FAFAF9;
      --color-surface: #FFFFFF;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-up {
      animation: slideUp 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes slideInLeft {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    .animate-slide-in-left {
      animation: slideInLeft 0.25s ease-out;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #F5F5F4;
    }
    
    .dark ::-webkit-scrollbar-track {
      background: #292524;
    }

    ::-webkit-scrollbar-thumb {
      background: #0F766E;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #14B8A6;
    }

    /* Loading spinner */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #FAFAF9;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .dark #loading {
      background: #1C1917;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e7e5e4;
      border-top: 4px solid #0F766E;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .dark .spinner {
      border: 4px solid #44403c;
      border-top: 4px solid #14B8A6;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Print Styles - Only print calendar */
    @media print {
      @page {
        size: landscape;
        margin: 0.5in;
      }
      
      body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      
      /* Hide everything except calendar content */
      nav,
      header,
      .no-print,
      button:not(.print-show),
      input,
      .bg-amber-50,
      [class*="hover:"] {
        display: none !important;
      }
      
      /* Show only calendar grid */
      .calendar-grid,
      .calendar-print-header {
        display: block !important;
      }
      
      /* Calendar-specific print styles */
      .print-header {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #0F766E;
      }
      
      .print-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0F766E;
      }
      
      .print-date {
        font-size: 1rem;
        color: #57534e;
      }
      
      /* Optimize calendar grid for printing */
      .calendar-grid {
        page-break-inside: avoid;
        width: 100%;
      }
      
      /* Ensure lesson blocks print with colors */
      .lesson-block {
        border: 1px solid #d6d3d1 !important;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body class="bg-stone-50">
  <div id="loading">
    <div class="spinner"></div>
  </div>
  <div id="root"></div>

  <script type="text/babel" data-presets="react" data-type="module">
    const { useState, useEffect, useRef, useMemo } = React;
    const { createRoot } = ReactDOM;

    // Icons (simplified SVG components)
    const Calendar = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const Users = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
    );

    const DollarSign = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
    );

    const CheckCircle = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    );

    const ArrowRight = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    );

    const Music = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M9 18V5l12-2v13"></path>
        <circle cx="6" cy="18" r="3"></circle>
        <circle cx="18" cy="16" r="3"></circle>
      </svg>
    );

    const ChevronLeft = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronRight = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const ChevronDown = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const Plus = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const X = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const Moon = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    );

    const Sun = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    );

    const Menu = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <line x1="3" y1="6" x2="21" y2="6" strokeWidth="2" strokeLinecap="round"></line>
        <line x1="3" y1="12" x2="21" y2="12" strokeWidth="2" strokeLinecap="round"></line>
        <line x1="3" y1="18" x2="21" y2="18" strokeWidth="2" strokeLinecap="round"></line>
      </svg>
    );

    // Local Storage Hook
    const useLocalStorage = (key, initialValue) => {
      const [value, setValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          return initialValue;
        }
      });

      useEffect(() => {
        window.localStorage.setItem(key, JSON.stringify(value));
      }, [key, value]);

      return [value, setValue];
    };

    // Utility function to convert 24hr to 12hr format (used by multiple components)
    const formatTime12Hour = (time24) => {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
      return `${hour12}:${minutes} ${ampm}`;
    };

    // Recurring date generation utility (Google Calendar-style)
    const generateRecurringDates = ({ startDate, frequency, repeatDays, endType, endDate, count }) => {
      const dates = [];
      const start = new Date(startDate + 'T12:00:00'); // noon to avoid DST issues
      const maxOccurrences = 52; // safety cap for 'never'

      if (frequency === 'daily') {
        const limit = endType === 'after' ? count : endType === 'never' ? maxOccurrences : 365;
        const endDt = endType === 'on' && endDate ? new Date(endDate + 'T23:59:59') : null;
        let current = new Date(start);
        while (dates.length < limit) {
          if (endDt && current > endDt) break;
          dates.push(current.toISOString().split('T')[0]);
          current.setDate(current.getDate() + 1);
        }
      } else if (frequency === 'weekly' || frequency === 'biweekly') {
        const limit = endType === 'after' ? count : endType === 'never' ? maxOccurrences : 365;
        const endDt = endType === 'on' && endDate ? new Date(endDate + 'T23:59:59') : null;
        const days = repeatDays && repeatDays.length > 0 ? repeatDays : [start.getDay()];
        let current = new Date(start);
        // Find the start of the week containing our start date (Sunday)
        const weekStart = new Date(start);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        let weekNumber = 0;

        // Scan up to 2 years out max
        const scanLimit = new Date(start);
        scanLimit.setFullYear(scanLimit.getFullYear() + 2);

        while (dates.length < limit && current <= scanLimit) {
          if (endDt && current > endDt) break;
          // Calculate which week we're in relative to start
          const daysSinceStart = Math.floor((current - weekStart) / (1000 * 60 * 60 * 24));
          const currentWeek = Math.floor(daysSinceStart / 7);
          const isValidWeek = frequency === 'weekly' || (currentWeek % 2 === 0);

          if (isValidWeek && days.includes(current.getDay())) {
            // Only include dates on or after the original start date
            if (current >= start) {
              dates.push(current.toISOString().split('T')[0]);
            }
          }
          current.setDate(current.getDate() + 1);
        }
      } else if (frequency === 'monthly') {
        const limit = endType === 'after' ? count : endType === 'never' ? maxOccurrences : 24;
        const endDt = endType === 'on' && endDate ? new Date(endDate + 'T23:59:59') : null;
        const dayOfMonth = start.getDate();
        let current = new Date(start);
        for (let i = 0; i < limit; i++) {
          if (endDt && current > endDt) break;
          dates.push(current.toISOString().split('T')[0]);
          // Move to next month, clamping to last day if needed
          const nextMonth = new Date(current);
          nextMonth.setMonth(nextMonth.getMonth() + 1);
          nextMonth.setDate(Math.min(dayOfMonth, new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 1, 0).getDate()));
          current = nextMonth;
        }
      }

      return dates;
    };

    // Demo Data Generator
    const generateDemoData = () => {
      const students = [
        // Elementary students (ages 8-12) - mostly have parents
        { id: 1, name: 'Emma Thompson', email: 'emma.thompson@email.com', phone: '214-555-0101', isMinor: true, parentName: 'Sarah Thompson', parentEmail: 'sarah.thompson@email.com', parentPhone: '214-555-0101', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 2, name: 'Liam Anderson', email: 'liam.anderson@email.com', phone: '214-555-0102', isMinor: true, parentName: 'Michael Anderson', parentEmail: 'michael.anderson@email.com', parentPhone: '214-555-0102', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 3, name: 'Olivia Martinez', email: 'olivia.martinez@email.com', phone: '214-555-0103', isMinor: true, parentName: 'Rosa Martinez', parentEmail: 'rosa.martinez@email.com', parentPhone: '214-555-0103', defaultLessonType: 'Private Lesson', customRate: '45' },
        { id: 4, name: 'Noah Williams', email: 'noah.williams@email.com', phone: '214-555-0104', isMinor: true, parentName: 'Jennifer Williams', parentEmail: 'jennifer.williams@email.com', parentPhone: '214-555-0104', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 5, name: 'Ava Johnson', email: 'ava.johnson@email.com', phone: '214-555-0105', isMinor: true, parentName: 'David Johnson', parentEmail: 'david.johnson@email.com', parentPhone: '214-555-0105', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 6, name: 'Sophia Chen', email: 'sophia.chen@email.com', phone: '214-555-0106', isMinor: true, parentName: 'Lisa Chen', parentEmail: 'lisa.chen@email.com', parentPhone: '214-555-0106', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 7, name: 'Jackson Brown', email: 'jackson.brown@email.com', phone: '214-555-0107', isMinor: true, parentName: 'Mark Brown', parentEmail: 'mark.brown@email.com', parentPhone: '214-555-0107', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 8, name: 'Isabella Garcia', email: 'isabella.garcia@email.com', phone: '214-555-0108', isMinor: true, parentName: 'Maria Garcia', parentEmail: 'maria.garcia@email.com', parentPhone: '214-555-0108', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 9, name: 'Lucas Davis', email: 'lucas.davis@email.com', phone: '214-555-0109', isMinor: true, parentName: 'Robert Davis', parentEmail: 'robert.davis@email.com', parentPhone: '214-555-0109', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 10, name: 'Mia Rodriguez', email: 'mia.rodriguez@email.com', phone: '214-555-0110', isMinor: true, parentName: 'Carmen Rodriguez', parentEmail: 'carmen.rodriguez@email.com', parentPhone: '214-555-0110', defaultLessonType: 'Private Lesson', customRate: '' },
        
        // Middle school students (ages 11-14)
        { id: 11, name: 'Ethan Wilson', email: 'ethan.wilson@email.com', phone: '214-555-0111', isMinor: true, parentName: 'Amanda Wilson', parentEmail: 'amanda.wilson@email.com', parentPhone: '214-555-0111', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 12, name: 'Charlotte Moore', email: 'charlotte.moore@email.com', phone: '214-555-0112', isMinor: true, parentName: 'James Moore', parentEmail: 'james.moore@email.com', parentPhone: '214-555-0112', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 13, name: 'Mason Taylor', email: 'mason.taylor@email.com', phone: '214-555-0113', isMinor: true, parentName: 'Patricia Taylor', parentEmail: 'patricia.taylor@email.com', parentPhone: '214-555-0113', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 14, name: 'Amelia Thomas', email: 'amelia.thomas@email.com', phone: '214-555-0114', isMinor: true, parentName: 'Karen Thomas', parentEmail: 'karen.thomas@email.com', parentPhone: '214-555-0114', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 15, name: 'Logan Jackson', email: 'logan.jackson@email.com', phone: '214-555-0115', isMinor: true, parentName: 'Steven Jackson', parentEmail: 'steven.jackson@email.com', parentPhone: '214-555-0115', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 16, name: 'Harper White', email: 'harper.white@email.com', phone: '214-555-0116', isMinor: true, parentName: 'Michelle White', parentEmail: 'michelle.white@email.com', parentPhone: '214-555-0116', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 17, name: 'Elijah Harris', email: 'elijah.harris@email.com', phone: '214-555-0117', isMinor: true, parentName: 'Brian Harris', parentEmail: 'brian.harris@email.com', parentPhone: '214-555-0117', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 18, name: 'Evelyn Martin', email: 'evelyn.martin@email.com', phone: '214-555-0118', isMinor: true, parentName: 'Nancy Martin', parentEmail: 'nancy.martin@email.com', parentPhone: '214-555-0118', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 19, name: 'Aiden Lee', email: 'aiden.lee@email.com', phone: '214-555-0119', isMinor: true, parentName: 'Susan Lee', parentEmail: 'susan.lee@email.com', parentPhone: '214-555-0119', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 20, name: 'Abigail Walker', email: 'abigail.walker@email.com', phone: '214-555-0120', isMinor: true, parentName: 'Paul Walker', parentEmail: 'paul.walker@email.com', parentPhone: '214-555-0120', defaultLessonType: 'Group Lesson', customRate: '' },
        
        // High school students (ages 14-18)
        { id: 21, name: 'Benjamin Hall', email: 'benjamin.hall@email.com', phone: '214-555-0121', isMinor: true, parentName: 'Laura Hall', parentEmail: 'laura.hall@email.com', parentPhone: '214-555-0121', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 22, name: 'Emily Allen', email: 'emily.allen@email.com', phone: '214-555-0122', isMinor: true, parentName: 'George Allen', parentEmail: 'george.allen@email.com', parentPhone: '214-555-0122', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 23, name: 'Sebastian Young', email: 'sebastian.young@email.com', phone: '214-555-0123', isMinor: true, parentName: 'Barbara Young', parentEmail: 'barbara.young@email.com', parentPhone: '214-555-0123', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 24, name: 'Ella King', email: 'ella.king@email.com', phone: '214-555-0124', isMinor: true, parentName: 'Daniel King', parentEmail: 'daniel.king@email.com', parentPhone: '214-555-0124', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 25, name: 'Alexander Wright', email: 'alexander.wright@email.com', phone: '214-555-0125', isMinor: true, parentName: 'Rebecca Wright', parentEmail: 'rebecca.wright@email.com', parentPhone: '214-555-0125', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 26, name: 'Scarlett Lopez', email: 'scarlett.lopez@email.com', phone: '214-555-0126', isMinor: true, parentName: 'Antonio Lopez', parentEmail: 'antonio.lopez@email.com', parentPhone: '214-555-0126', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 27, name: 'Henry Hill', email: 'henry.hill@email.com', phone: '214-555-0127', isMinor: true, parentName: 'Dorothy Hill', parentEmail: 'dorothy.hill@email.com', parentPhone: '214-555-0127', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 28, name: 'Grace Scott', email: 'grace.scott@email.com', phone: '214-555-0128', isMinor: true, parentName: 'Edward Scott', parentEmail: 'edward.scott@email.com', parentPhone: '214-555-0128', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 29, name: 'Jack Green', email: 'jack.green@email.com', phone: '214-555-0129', isMinor: true, parentName: 'Sandra Green', parentEmail: 'sandra.green@email.com', parentPhone: '214-555-0129', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 30, name: 'Chloe Adams', email: 'chloe.adams@email.com', phone: '214-555-0130', isMinor: true, parentName: 'Kevin Adams', parentEmail: 'kevin.adams@email.com', parentPhone: '214-555-0130', defaultLessonType: 'Private Lesson', customRate: '' },
        
        // More high school students
        { id: 31, name: 'Daniel Baker', email: 'daniel.baker@email.com', phone: '214-555-0131', isMinor: true, parentName: 'Angela Baker', parentEmail: 'angela.baker@email.com', parentPhone: '214-555-0131', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 32, name: 'Madison Nelson', email: 'madison.nelson@email.com', phone: '214-555-0132', isMinor: true, parentName: 'Timothy Nelson', parentEmail: 'timothy.nelson@email.com', parentPhone: '214-555-0132', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 33, name: 'Samuel Carter', email: 'samuel.carter@email.com', phone: '214-555-0133', isMinor: true, parentName: 'Helen Carter', parentEmail: 'helen.carter@email.com', parentPhone: '214-555-0133', defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 34, name: 'Lily Mitchell', email: 'lily.mitchell@email.com', phone: '214-555-0134', isMinor: true, parentName: 'Joshua Mitchell', parentEmail: 'joshua.mitchell@email.com', parentPhone: '214-555-0134', defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 35, name: 'Matthew Perez', email: 'matthew.perez@email.com', phone: '214-555-0135', isMinor: true, parentName: 'Melissa Perez', parentEmail: 'melissa.perez@email.com', parentPhone: '214-555-0135', defaultLessonType: 'Private Lesson', customRate: '' },
        
        // Adult students (no parents)
        { id: 36, name: 'Rachel Cooper', email: 'rachel.cooper@email.com', phone: '214-555-0136', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 37, name: 'Andrew Richardson', email: 'andrew.richardson@email.com', phone: '214-555-0137', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 38, name: 'Victoria Cox', email: 'victoria.cox@email.com', phone: '214-555-0138', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '55' },
        { id: 39, name: 'Ryan Howard', email: 'ryan.howard@email.com', phone: '214-555-0139', isMinor: false, defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 40, name: 'Natalie Ward', email: 'natalie.ward@email.com', phone: '214-555-0140', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 41, name: 'Christopher Torres', email: 'chris.torres@email.com', phone: '214-555-0141', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 42, name: 'Hannah Peterson', email: 'hannah.peterson@email.com', phone: '214-555-0142', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 43, name: 'Nicholas Gray', email: 'nicholas.gray@email.com', phone: '214-555-0143', isMinor: false, defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 44, name: 'Samantha Ramirez', email: 'samantha.ramirez@email.com', phone: '214-555-0144', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 45, name: 'Tyler James', email: 'tyler.james@email.com', phone: '214-555-0145', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 46, name: 'Lauren Watson', email: 'lauren.watson@email.com', phone: '214-555-0146', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 47, name: 'Brandon Brooks', email: 'brandon.brooks@email.com', phone: '214-555-0147', isMinor: false, defaultLessonType: 'Group Lesson', customRate: '' },
        { id: 48, name: 'Ashley Kelly', email: 'ashley.kelly@email.com', phone: '214-555-0148', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 49, name: 'Justin Sanders', email: 'justin.sanders@email.com', phone: '214-555-0149', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '' },
        { id: 50, name: 'Stephanie Price', email: 'stephanie.price@email.com', phone: '214-555-0150', isMinor: false, defaultLessonType: 'Private Lesson', customRate: '60' },
      ];

      // Generate lessons Monday-Friday 8am-4pm through June 30, 2026
      const lessons = [];
      let lessonId = 1;
      const startDate = new Date('2026-02-18'); // Start from tomorrow
      const endDate = new Date('2026-06-30');
      
      // Time slots available each day (8am-4pm, 30-min intervals)
      const timeSlots = [
        '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
        '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30'
      ];

      // Assign each student a recurring weekly time slot
      const studentSchedules = students.map((student, index) => {
        const dayOfWeek = index % 5; // 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri
        const timeSlot = timeSlots[index % timeSlots.length];
        const lessonType = student.defaultLessonType;
        const duration = lessonType === 'Private Lesson' ? 30 : lessonType === 'Group Lesson' ? 45 : 60;
        const rate = student.customRate || (lessonType === 'Private Lesson' ? 50 : lessonType === 'Group Lesson' ? 40 : 25);
        
        return {
          studentId: student.id,
          dayOfWeek,
          time: timeSlot,
          lessonType,
          duration,
          rate: parseFloat(rate)
        };
      });

      // Generate lessons for each week
      const currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const dayOfWeek = currentDate.getDay();
        
        // Skip weekends
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          const mondayBasedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          
          // Find students scheduled for this day
          const todayStudents = studentSchedules.filter(s => s.dayOfWeek === mondayBasedDay);
          
          todayStudents.forEach(schedule => {
            const dateStr = currentDate.toISOString().split('T')[0];
            const isPast = currentDate < new Date();
            
            lessons.push({
              id: lessonId++,
              studentId: schedule.studentId,
              date: dateStr,
              time: schedule.time,
              lessonType: schedule.lessonType,
              duration: schedule.duration,
              rate: schedule.rate,
              status: isPast ? 'completed' : 'scheduled',
              attendance: isPast ? (Math.random() > 0.1 ? 'present' : 'absent') : undefined,
              notes: isPast && Math.random() > 0.7 ? 'Great progress! Student is mastering scales.' : undefined
            });
          });
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
      }

      return { students, lessons };
    };

    // Main App Component
    function CadenceApp() {
      const [user, setUser] = useLocalStorage('cadence_user', null);
      const [setupComplete, setSetupComplete] = useLocalStorage('cadence_setup_complete', false);
      const [students, setStudents] = useLocalStorage('cadence_students', []);
      const [lessons, setLessons] = useLocalStorage('cadence_lessons', []);
      const [currentView, setCurrentView] = useState('calendar');
      const [darkMode, setDarkMode] = useLocalStorage('cadence_dark_mode', false);
      const [sidebarOpen, setSidebarOpen] = useState(false);

      // Hide loading spinner when component mounts
      useEffect(() => {
        const loader = document.getElementById('loading');
        if (loader) loader.style.display = 'none';
      }, []);
      
      // Apply dark mode to document
      useEffect(() => {
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode]);

      // If no user, show auth
      if (!user) {
        return <AuthScreen setUser={setUser} />;
      }

      // If user but setup not complete, show onboarding
      if (!setupComplete) {
        return <OnboardingFlow user={user} setUser={setUser} setSetupComplete={setSetupComplete} setStudents={setStudents} setLessons={setLessons} />;
      }

      // Main app
      return (
        <div className="min-h-screen bg-stone-50 dark:bg-stone-900 transition-colors">
          <Header user={user} setUser={setUser} setSetupComplete={setSetupComplete} darkMode={darkMode} setDarkMode={setDarkMode} sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />
          <div className="flex">
            <Sidebar currentView={currentView} setCurrentView={setCurrentView} darkMode={darkMode} sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />
            <main className="flex-1 p-4 sm:p-6 lg:p-8 min-w-0">
              {currentView === 'calendar' && (
                <CalendarView
                  user={user}
                  students={students}
                  lessons={lessons}
                  setLessons={setLessons}
                  setStudents={setStudents}
                />
              )}
              {currentView === 'students' && (
                <StudentsView students={students} lessons={lessons} setStudents={setStudents} user={user} />
              )}
              {currentView === 'billing' && (
                <BillingView lessons={lessons} students={students} />
              )}
            </main>
          </div>
        </div>
      );
    }

    // Header Component
    function Header({ user, setUser, setSetupComplete, darkMode, setDarkMode, sidebarOpen, setSidebarOpen }) {
      const [showModeTooltip, setShowModeTooltip] = useState(false);
      const hoverTimerRef = React.useRef(null);
      const hideTimerRef = React.useRef(null);

      const handleToggleMouseEnter = () => {
        clearTimeout(hideTimerRef.current);
        hoverTimerRef.current = setTimeout(() => {
          setShowModeTooltip(true);
          hideTimerRef.current = setTimeout(() => setShowModeTooltip(false), 3000);
        }, 1000);
      };

      const handleToggleMouseLeave = () => {
        clearTimeout(hoverTimerRef.current);
        clearTimeout(hideTimerRef.current);
        setShowModeTooltip(false);
      };

      return (
        <header className="bg-white dark:bg-stone-800 border-b border-stone-200 dark:border-stone-700 px-4 py-3 lg:px-8 lg:py-4 transition-colors">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {/* Hamburger menu - mobile/tablet only */}
              <button
                onClick={() => setSidebarOpen(!sidebarOpen)}
                className="lg:hidden p-2 -ml-2 rounded-lg hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors"
              >
                <Menu className="w-6 h-6 text-stone-700 dark:text-stone-300" />
              </button>
              <div className="w-10 h-10 bg-teal-700 dark:bg-teal-600 rounded-lg flex items-center justify-center transition-colors">
                <Music className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl sm:text-2xl font-bold text-stone-900 dark:text-stone-100 transition-colors">Cadence</h1>
                <p className="text-xs text-stone-500 dark:text-stone-400 transition-colors hidden sm:block">Music Lesson Management</p>
              </div>
            </div>
            <div className="flex items-center gap-2 sm:gap-4">
              {/* Dark Mode Toggle */}
              <div className="relative">
                <button
                  onClick={() => setDarkMode(!darkMode)}
                  onMouseEnter={handleToggleMouseEnter}
                  onMouseLeave={handleToggleMouseLeave}
                  className="p-2 rounded-lg bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 transition-colors"
                >
                  {darkMode ? (
                    <Sun className="w-5 h-5 text-stone-700 dark:text-stone-300" />
                  ) : (
                    <Moon className="w-5 h-5 text-stone-700" />
                  )}
                </button>
                <div className={`absolute top-full left-1/2 -translate-x-1/2 mt-2 px-3 py-1.5 bg-stone-900 dark:bg-stone-100 text-white dark:text-stone-900 text-xs font-medium rounded-lg whitespace-nowrap pointer-events-none transition-opacity duration-200 z-50 ${showModeTooltip ? 'opacity-100' : 'opacity-0'}`}>
                  {darkMode ? 'Day Mode' : 'Night Mode'}
                  <div className="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-stone-900 dark:border-b-stone-100"></div>
                </div>
              </div>

              <span className="text-stone-700 dark:text-stone-300 font-medium transition-colors hidden sm:inline">{user.businessName || user.name}</span>
              <button
                onClick={() => {
                  setUser(null);
                  setSetupComplete(false);
                }}
                className="text-sm text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-200 transition-colors"
              >
                Logout
              </button>
            </div>
          </div>
        </header>
      );
    }

    // Sidebar Component
    function Sidebar({ currentView, setCurrentView, darkMode, sidebarOpen, setSidebarOpen }) {
      const navItems = [
        { id: 'calendar', label: 'Calendar', icon: Calendar },
        { id: 'students', label: 'Students', icon: Users },
        { id: 'billing', label: 'Billing', icon: DollarSign },
      ];

      const navContent = (
        <div className="space-y-2">
          {navItems.map(item => (
            <button
              key={item.id}
              onClick={() => {
                setCurrentView(item.id);
                setSidebarOpen(false);
              }}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${
                currentView === item.id
                  ? 'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 font-medium'
                  : 'text-stone-600 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-700/50'
              }`}
            >
              <item.icon className="w-5 h-5" />
              <span>{item.label}</span>
            </button>
          ))}
        </div>
      );

      return (
        <React.Fragment>
          {/* Desktop sidebar */}
          <nav className="hidden lg:block w-64 bg-white dark:bg-stone-800 border-r border-stone-200 dark:border-stone-700 min-h-screen p-6 transition-colors flex-shrink-0">
            {navContent}
          </nav>

          {/* Mobile/Tablet drawer overlay */}
          {sidebarOpen && (
            <div className="lg:hidden fixed inset-0 z-40">
              {/* Backdrop */}
              <div
                className="absolute inset-0 bg-black/50"
                onClick={() => setSidebarOpen(false)}
              />
              {/* Drawer */}
              <nav className="absolute inset-y-0 left-0 w-64 bg-white dark:bg-stone-800 border-r border-stone-200 dark:border-stone-700 p-6 shadow-xl animate-slide-in-left">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-teal-700 dark:bg-teal-600 rounded-lg flex items-center justify-center">
                      <Music className="w-5 h-5 text-white" />
                    </div>
                    <span className="font-bold text-stone-900 dark:text-stone-100">Cadence</span>
                  </div>
                  <button
                    onClick={() => setSidebarOpen(false)}
                    className="p-2 rounded-lg hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors"
                  >
                    <X className="w-5 h-5 text-stone-500 dark:text-stone-400" />
                  </button>
                </div>
                {navContent}
              </nav>
            </div>
          )}
        </React.Fragment>
      );
    }

    // Auth Screen Component
    function AuthScreen({ setUser }) {
      const [isLogin, setIsLogin] = useState(false); // Default to signup
      const [formData, setFormData] = useState({ email: '', password: '', name: '' });

      const handleSubmit = (e) => {
        e.preventDefault();
        const newUser = {
          id: Date.now(),
          email: formData.email,
          name: formData.name || formData.email.split('@')[0],
        };
        setUser(newUser);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-teal-50 to-amber-50 flex items-center justify-center p-4">
          <div className="w-full max-w-md animate-slide-up">
            <div className="text-center mb-8">
              <div className="inline-flex w-16 h-16 bg-teal-700 rounded-2xl items-center justify-center mb-4">
                <Music className="w-10 h-10 text-white" />
              </div>
              <h1 className="text-4xl font-bold text-stone-900 mb-2">Cadence</h1>
              <p className="text-stone-600">Manage your music lessons effortlessly</p>
            </div>

            <div className="bg-white rounded-2xl p-8 shadow-lg border border-stone-200">
              <div className="flex gap-2 mb-6">
                <button
                  onClick={() => setIsLogin(true)}
                  className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                    isLogin ? 'bg-teal-700 text-white' : 'text-stone-600 hover:bg-stone-50'
                  }`}
                >
                  Login
                </button>
                <button
                  onClick={() => setIsLogin(false)}
                  className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                    !isLogin ? 'bg-teal-700 text-white' : 'text-stone-600 hover:bg-stone-50'
                  }`}
                >
                  Sign Up
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                {!isLogin && (
                  <input
                    type="text"
                    placeholder="Your Name"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    className="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                    required
                  />
                )}
                <input
                  type="email"
                  placeholder="Email"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  className="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  required
                />
                <input
                  type="password"
                  placeholder="Password"
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                  className="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  required
                />
                <button
                  type="submit"
                  className="w-full py-3 bg-teal-700 text-white font-medium rounded-lg hover:bg-teal-600 transition-colors"
                >
                  {isLogin ? 'Login' : 'Create Account'}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // Onboarding Flow Component
    function OnboardingFlow({ user, setUser, setSetupComplete, setStudents, setLessons }) {
      const [step, setStep] = useState(1);
      const [data, setData] = useState({
        businessName: '',
        lessonTypes: [
          { name: 'Private Lesson', duration: 30, rate: 50 },
        ],
      });

      const addLessonType = () => {
        setData({
          ...data,
          lessonTypes: [...data.lessonTypes, { name: '', duration: 30, rate: 0 }]
        });
      };

      const updateLessonType = (index, field, value) => {
        const updated = [...data.lessonTypes];
        updated[index][field] = value;
        setData({ ...data, lessonTypes: updated });
      };

      const removeLessonType = (index) => {
        const updated = data.lessonTypes.filter((_, i) => i !== index);
        setData({ ...data, lessonTypes: updated });
      };

      const handleComplete = () => {
        setUser({ ...user, ...data });
        
        // Check if this is Jennaca's account - load demo data
        if (user.email.toLowerCase().includes('jennaca') || user.name.toLowerCase().includes('jennaca') || data.businessName.toLowerCase().includes('jennaca')) {
          console.log('Loading demo data for Jennaca...');
          const demoData = generateDemoData();
          setStudents(demoData.students);
          setLessons(demoData.lessons);
        }
        
        setSetupComplete(true);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-teal-50 to-amber-50 flex items-center justify-center p-4">
          <div className="w-full max-w-2xl animate-slide-up">
            {/* Progress Bar */}
            <div className="mb-8">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-stone-600">Step {step} of 2</span>
                <span className="text-sm text-stone-600">{Math.round((step / 2) * 100)}% Complete</span>
              </div>
              <div className="h-2 bg-stone-200 rounded-full overflow-hidden">
                <div
                  className="h-full bg-teal-700 transition-all duration-300"
                  style={{ width: `${(step / 2) * 100}%` }}
                />
              </div>
            </div>

            {/* Step Content */}
            <div className="bg-white rounded-2xl p-8 shadow-lg border border-stone-200">
              {step === 1 && (
                <div className="space-y-6">
                  <div>
                    <h2 className="text-3xl font-bold text-stone-900 mb-2">Welcome to Cadence!</h2>
                    <p className="text-stone-600">Let's get your studio set up in just 2 quick steps.</p>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-stone-700 mb-2">
                      What should we call your studio or business?
                    </label>
                    <input
                      type="text"
                      value={data.businessName}
                      onChange={(e) => setData({ ...data, businessName: e.target.value })}
                      placeholder="e.g., Sarah's Piano Studio"
                      className="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                    />
                    <p className="mt-2 text-sm text-stone-500">This will appear on invoices and communications.</p>
                  </div>

                  <button
                    onClick={() => setStep(2)}
                    disabled={!data.businessName}
                    className="w-full py-3 bg-teal-700 text-white font-medium rounded-lg hover:bg-teal-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    Continue
                    <ArrowRight className="w-5 h-5" />
                  </button>
                </div>
              )}

              {step === 2 && (
                <div className="space-y-6">
                  <div>
                    <h2 className="text-3xl font-bold text-stone-900 mb-2">Set Your Lesson Types</h2>
                    <p className="text-stone-600">Define your lesson types with default rates and durations.</p>
                  </div>

                  <div className="space-y-4">
                    {data.lessonTypes.map((type, index) => (
                      <div key={index} className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                        <div className="flex items-start gap-4">
                          <div className="flex-1 space-y-3">
                            <input
                              type="text"
                              value={type.name}
                              onChange={(e) => updateLessonType(index, 'name', e.target.value)}
                              placeholder="Lesson type (e.g., Private, Group, Class)"
                              className="w-full px-3 py-2 bg-white border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                            />
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="block text-xs text-stone-600 mb-1">Duration (min)</label>
                                <input
                                  type="number"
                                  value={type.duration}
                                  onChange={(e) => updateLessonType(index, 'duration', parseInt(e.target.value))}
                                  className="w-full px-3 py-2 bg-white border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-stone-600 mb-1">Rate ($)</label>
                                <input
                                  type="number"
                                  value={type.rate}
                                  onChange={(e) => updateLessonType(index, 'rate', parseFloat(e.target.value))}
                                  className="w-full px-3 py-2 bg-white border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                />
                              </div>
                            </div>
                          </div>
                          {data.lessonTypes.length > 1 && (
                            <button
                              onClick={() => removeLessonType(index)}
                              className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                            >
                              <X className="w-5 h-5" />
                            </button>
                          )}
                        </div>
                      </div>
                    ))}

                    <button
                      onClick={addLessonType}
                      className="w-full py-3 border-2 border-dashed border-stone-300 text-stone-600 rounded-lg hover:border-teal-500 hover:text-teal-700 transition-colors flex items-center justify-center gap-2"
                    >
                      <Plus className="w-5 h-5" />
                      Add Another Lesson Type
                    </button>
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={() => setStep(1)}
                      className="px-6 py-3 border border-stone-300 text-stone-700 rounded-lg hover:bg-stone-50 transition-colors flex items-center gap-2"
                    >
                      <ChevronLeft className="w-5 h-5" />
                      Back
                    </button>
                    <button
                      onClick={handleComplete}
                      disabled={data.lessonTypes.some(t => !t.name || !t.rate)}
                      className="flex-1 py-3 bg-teal-700 text-white font-medium rounded-lg hover:bg-teal-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      <CheckCircle className="w-5 h-5" />
                      Complete Setup
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Schedule List View Component (within Calendar)
    function ScheduleListView({ user, students, lessons, setLessons, setSelectedLesson, setShowRescheduleModal }) {
      const [filterStatus, setFilterStatus] = useState('all'); // all, scheduled, completed, cancelled
      const [filterDays, setFilterDays] = useState(30); // 7, 30, 90, all

      // Get today's date
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Filter lessons by date range and status
      const filteredLessons = lessons
        .filter(lesson => {
          // Status filter
          if (filterStatus !== 'all' && lesson.status !== filterStatus) return false;
          
          // Date filter
          const lessonDate = new Date(lesson.date + 'T00:00:00');
          const daysDiff = Math.ceil((lessonDate - today) / (1000 * 60 * 60 * 24));
          
          if (filterDays === 'all') return true;
          if (filterDays === 'past') return daysDiff < 0;
          return daysDiff >= 0 && daysDiff <= filterDays;
        })
        .sort((a, b) => {
          // Sort by date, then time
          if (a.date === b.date) {
            return a.time.localeCompare(b.time);
          }
          return a.date.localeCompare(b.date);
        });

      // Group lessons by date
      const groupedLessons = filteredLessons.reduce((groups, lesson) => {
        const date = lesson.date;
        if (!groups[date]) groups[date] = [];
        groups[date].push(lesson);
        return groups;
      }, {});

      const formatDateHeader = (dateStr) => {
        const date = new Date(dateStr + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        if (date.toDateString() === today.toDateString()) return 'Today';
        if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
        
        return date.toLocaleDateString('en-US', { 
          weekday: 'long', 
          month: 'long', 
          day: 'numeric',
          year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
        });
      };

      return (
        <div className="space-y-4 sm:space-y-6">
          {/* Filters */}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <p className="text-stone-600 dark:text-stone-400 text-sm sm:text-base">View all your lessons in a list format</p>

            <div className="flex gap-2 sm:gap-3">
              <select
                value={filterDays}
                onChange={(e) => setFilterDays(e.target.value === 'all' || e.target.value === 'past' ? e.target.value : parseInt(e.target.value))}
                className="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm text-stone-900 dark:text-stone-100"
              >
                <option value="past">Past Lessons</option>
                <option value="7">Next 7 Days</option>
                <option value="30">Next 30 Days</option>
                <option value="90">Next 90 Days</option>
                <option value="all">All Upcoming</option>
              </select>

              <select
                value={filterStatus}
                onChange={(e) => setFilterStatus(e.target.value)}
                className="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm text-stone-900 dark:text-stone-100"
              >
                <option value="all">All Status</option>
                <option value="scheduled">Scheduled</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
            <div className="bg-white dark:bg-stone-800 rounded-xl p-4 border border-stone-200 dark:border-stone-700">
              <div className="text-2xl font-bold text-stone-900 dark:text-stone-100">{filteredLessons.length}</div>
              <div className="text-sm text-stone-600 dark:text-stone-400">Total Lessons</div>
            </div>
            <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
              <div className="text-2xl font-bold text-blue-900 dark:text-blue-400">
                {filteredLessons.filter(l => l.status === 'scheduled').length}
              </div>
              <div className="text-sm text-blue-700 dark:text-blue-400">Scheduled</div>
            </div>
            <div className="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800">
              <div className="text-2xl font-bold text-green-900 dark:text-green-400">
                {filteredLessons.filter(l => l.status === 'completed').length}
              </div>
              <div className="text-sm text-green-700 dark:text-green-400">Completed</div>
            </div>
            <div className="bg-red-50 dark:bg-red-900/20 rounded-xl p-4 border border-red-200 dark:border-red-800">
              <div className="text-2xl font-bold text-red-900 dark:text-red-400">
                {filteredLessons.filter(l => l.status === 'cancelled').length}
              </div>
              <div className="text-sm text-red-700 dark:text-red-400">Cancelled</div>
            </div>
          </div>

          {/* Lessons List */}
          {Object.keys(groupedLessons).length === 0 ? (
            <div className="bg-white dark:bg-stone-800 rounded-xl p-12 border border-stone-200 dark:border-stone-700 text-center">
              <Calendar className="w-16 h-16 text-stone-300 dark:text-stone-600 mx-auto mb-4" />
              <h3 className="text-xl font-bold text-stone-900 dark:text-stone-100 mb-2">No lessons found</h3>
              <p className="text-stone-600 dark:text-stone-400">Try adjusting your filters or add some lessons to your calendar.</p>
            </div>
          ) : (
            <div className="space-y-6">
              {Object.entries(groupedLessons).map(([date, dayLessons]) => (
                <div key={date} className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden">
                  {/* Date Header */}
                  <div className="bg-stone-50 dark:bg-stone-700 border-b border-stone-200 dark:border-stone-600 px-4 sm:px-6 py-3">
                    <h3 className="font-bold text-stone-900 dark:text-stone-100">{formatDateHeader(date)}</h3>
                    <p className="text-sm text-stone-500 dark:text-stone-400">
                      {new Date(date + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                    </p>
                  </div>

                  {/* Lessons for this date */}
                  <div className="divide-y divide-stone-100 dark:divide-stone-700">
                    {dayLessons.map(lesson => {
                      const student = students.find(s => s.id === lesson.studentId);

                      return (
                        <div
                          key={lesson.id}
                          onClick={() => setSelectedLesson(lesson)}
                          className="px-4 py-3 sm:px-6 sm:py-4 hover:bg-stone-50 dark:hover:bg-stone-700 cursor-pointer transition-colors"
                        >
                          <div className="flex items-center justify-between">
                            {/* Left: Time & Student Info */}
                            <div className="flex items-center gap-3 sm:gap-4">
                              <div className="text-center">
                                <div className="text-lg font-bold text-stone-900 dark:text-stone-100">
                                  {formatTime12Hour(lesson.time)}
                                </div>
                                <div className="text-xs text-stone-500 dark:text-stone-400">{lesson.duration} min</div>
                              </div>

                              <div className="h-12 w-px bg-stone-200 dark:bg-stone-600"></div>

                              <div>
                                <div className="font-semibold text-stone-900 dark:text-stone-100">{student?.name}</div>
                                <div className="text-sm text-stone-600 dark:text-stone-400">{lesson.lessonType}</div>
                              </div>
                            </div>

                            {/* Right: Status & Details */}
                            <div className="flex items-center gap-4">
                              {lesson.sessionNumber && (
                                <div className="text-sm text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 px-3 py-1 rounded-full">
                                  Session {lesson.sessionNumber}/{lesson.totalSessions}
                                </div>
                              )}
                              
                              {lesson.attendance && (
                                <div className={`text-sm px-3 py-1 rounded-full ${
                                  lesson.attendance === 'present'
                                    ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                                    : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
                                }`}>
                                  {lesson.attendance === 'present' ? ' Present' : ' Absent'}
                                </div>
                              )}

                              <div className={`px-4 py-2 rounded-lg font-medium ${
                                lesson.status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                                lesson.status === 'cancelled' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400' :
                                'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400'
                              }`}>
                                {lesson.status}
                              </div>
                              
                              <div className="text-lg font-bold text-teal-700 dark:text-teal-400">${lesson.rate}</div>

                              <svg className="w-5 h-5 text-stone-400 dark:text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                              </svg>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Calendar View Component
    function CalendarView({ user, students, lessons, setLessons, setStudents }) {
      const [view, setView] = useState('week'); // 'day', 'week', 'month', 'schedule'
      const [currentDate, setCurrentDate] = useState(new Date());
      const [showAddLesson, setShowAddLesson] = useState(null); // {date, time}
      const [selectedLesson, setSelectedLesson] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [showRescheduleModal, setShowRescheduleModal] = useState(null);
      const [draggedLesson, setDraggedLesson] = useState(null);
      const [hoveredLesson, setHoveredLesson] = useState(null);
      
      // Keyboard shortcuts visibility - show by default on first visit
      const [showKeyboardShortcuts, setShowKeyboardShortcuts] = useState(() => {
        const saved = window.localStorage.getItem('cadence_show_keyboard_shortcuts');
        return saved === null ? true : saved === 'true'; // Default to true on first visit
      });
      
      // Save keyboard shortcuts visibility to localStorage
      useEffect(() => {
        window.localStorage.setItem('cadence_show_keyboard_shortcuts', showKeyboardShortcuts.toString());
      }, [showKeyboardShortcuts]);

      // Keyboard navigation
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          const newDate = new Date(currentDate);
          
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            if (view === 'day') newDate.setDate(newDate.getDate() - 1);
            if (view === 'week') newDate.setDate(newDate.getDate() - 7);
            if (view === 'month') newDate.setMonth(newDate.getMonth() - 1);
            if (view === 'year') newDate.setFullYear(newDate.getFullYear() - 1);
            setCurrentDate(newDate);
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            if (view === 'day') newDate.setDate(newDate.getDate() + 1);
            if (view === 'week') newDate.setDate(newDate.getDate() + 7);
            if (view === 'month') newDate.setMonth(newDate.getMonth() + 1);
            if (view === 'year') newDate.setFullYear(newDate.getFullYear() + 1);
            setCurrentDate(newDate);
          } else if (e.key === 't' || e.key === 'T') {
            e.preventDefault();
            setCurrentDate(new Date());
          } else if (e.key === 'd' || e.key === 'D') {
            e.preventDefault();
            setView('day');
          } else if (e.key === 'w' || e.key === 'W') {
            e.preventDefault();
            setView('week');
          } else if (e.key === 'm' || e.key === 'M') {
            e.preventDefault();
            setView('month');
          } else if (e.key === 'y' || e.key === 'Y') {
            e.preventDefault();
            setView('year');
          } else if (e.key === 's' || e.key === 'S') {
            e.preventDefault();
            setView('schedule');
          } else if (e.key === 'p' || e.key === 'P') {
            e.preventDefault();
            handlePrint();
          }
        };
        
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [currentDate, view]);

      // Print calendar
      const handlePrint = () => {
        window.print();
      };

      // Export calendar as text
      const handleExport = () => {
        let exportText = `${user.businessName || 'Music Studio'} - Calendar\n`;
        exportText += `${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}\n\n`;
        
        const sortedLessons = [...lessons].sort((a, b) => {
          if (a.date === b.date) return a.time.localeCompare(b.time);
          return a.date.localeCompare(b.date);
        });

        sortedLessons.forEach(lesson => {
          const student = students.find(s => s.id === lesson.studentId);
          const date = new Date(lesson.date + 'T00:00:00');
          exportText += `${date.toLocaleDateString()} - ${formatTime12Hour(lesson.time)} - ${student?.name} - ${lesson.lessonType} (${lesson.status})\n`;
        });

        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `calendar-${currentDate.getMonth() + 1}-${currentDate.getFullYear()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      };

      // Handle drag and drop
      const handleDragStart = (lesson) => {
        setDraggedLesson(lesson);
      };

      const handleDrop = (date, time) => {
        if (!draggedLesson) return;
        
        const updatedLesson = {
          ...draggedLesson,
          date: date,
          time: time || draggedLesson.time
        };
        
        setLessons(lessons.map(l => l.id === draggedLesson.id ? updatedLesson : l));
        setDraggedLesson(null);
      };

      // Filter lessons by search
      const filteredLessons = lessons.filter(lesson => {
        if (!searchQuery) return true;
        const student = students.find(s => s.id === lesson.studentId);
        const searchLower = searchQuery.toLowerCase();
        return (
          student?.name.toLowerCase().includes(searchLower) ||
          lesson.lessonType.toLowerCase().includes(searchLower) ||
          lesson.date.includes(searchQuery)
        );
      });

      return (
        <div className="animate-fade-in space-y-4 sm:space-y-6">
          {/* Calendar Header - Row 1: Title + Search */}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pb-4 border-b border-stone-200 dark:border-stone-700">
            <h2 className="text-2xl sm:text-3xl font-bold text-stone-900 dark:text-stone-100">Calendar</h2>
            <div className="relative">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search lessons or students..."
                className="pl-10 pr-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 placeholder-stone-400 dark:placeholder-stone-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 w-full sm:w-80 transition-colors"
              />
              <svg className="w-5 h-5 text-stone-400 dark:text-stone-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
              </svg>
            </div>
          </div>

          {/* Calendar Header - Row 2: Schedule Lesson + Navigation + Actions */}
          <div className="flex flex-wrap items-center gap-2 sm:gap-3">
            {/* Left: Schedule Lesson Button */}
            <button
              onClick={() => setShowAddLesson({ date: currentDate.toISOString().split('T')[0], time: '07:00' })}
              className="flex items-center gap-2 px-3 sm:px-4 py-2 bg-teal-700 dark:bg-teal-600 text-white rounded-lg hover:bg-teal-600 dark:hover:bg-teal-500 transition-colors text-sm sm:text-base"
            >
              <Plus className="w-5 h-5" />
              <span className="hidden sm:inline">Schedule Lesson</span>
              <span className="sm:hidden">Schedule</span>
            </button>

            {/* Center: Date Navigation - Hidden in Schedule view */}
            {view !== 'schedule' && (
              <div className="flex items-center gap-1 sm:gap-2 flex-1 justify-center order-last sm:order-none w-full sm:w-auto">
                <button
                  onClick={() => setCurrentDate(new Date())}
                  className="px-3 sm:px-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-700 dark:text-stone-300 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors text-sm font-medium"
                  title="Today (T)"
                >
                  Today
                </button>
                <button
                  onClick={() => {
                    const newDate = new Date(currentDate);
                    if (view === 'day') newDate.setDate(newDate.getDate() - 1);
                    if (view === 'week') newDate.setDate(newDate.getDate() - 7);
                    if (view === 'month') newDate.setMonth(newDate.getMonth() - 1);
                    if (view === 'year') newDate.setFullYear(newDate.getFullYear() - 1);
                    setCurrentDate(newDate);
                  }}
                  className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors"
                  title="Previous ()"
                >
                  <ChevronLeft className="w-5 h-5 text-stone-700 dark:text-stone-300" />
                </button>
                <span className="px-2 sm:px-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg font-medium text-stone-900 dark:text-stone-100 min-w-[120px] sm:min-w-[200px] text-center transition-colors text-xs sm:text-base">
                  {view === 'month'
                    ? currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
                    : view === 'year'
                    ? currentDate.getFullYear()
                    : currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
                  }
                </span>
                <button
                  onClick={() => {
                    const newDate = new Date(currentDate);
                    if (view === 'day') newDate.setDate(newDate.getDate() + 1);
                    if (view === 'week') newDate.setDate(newDate.getDate() + 7);
                    if (view === 'month') newDate.setMonth(newDate.getMonth() + 1);
                    if (view === 'year') newDate.setFullYear(newDate.getFullYear() + 1);
                    setCurrentDate(newDate);
                  }}
                  className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors"
                  title="Next ()"
                >
                  <ChevronRight className="w-5 h-5 text-stone-700 dark:text-stone-300" />
                </button>
              </div>
            )}

            {/* Right: View Dropdown + Print/Export */}
            <div className="flex items-center gap-2 ml-auto">
              {/* View Dropdown */}
              <div className="relative">
                <select
                  value={view}
                  onChange={(e) => setView(e.target.value)}
                  className="appearance-none px-3 sm:px-4 py-2 pr-8 sm:pr-10 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400"
                >
                  <option value="day">Day</option>
                  <option value="week">Week</option>
                  <option value="month">Month</option>
                  <option value="year">Year</option>
                  <option value="schedule">List</option>
                </select>
                <ChevronDown className="w-4 h-4 text-stone-500 dark:text-stone-400 absolute right-2 sm:right-3 top-1/2 -translate-y-1/2 pointer-events-none" />
              </div>

              {/* Print Button */}
              <button
                onClick={handlePrint}
                className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors hidden sm:block"
                title="Print (P)"
              >
                <svg className="w-5 h-5 text-stone-600 dark:text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
                </svg>
              </button>

              {/* Export Button */}
              <button
                onClick={handleExport}
                className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors hidden sm:block"
                title="Export"
              >
                <svg className="w-5 h-5 text-stone-600 dark:text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
                </svg>
              </button>
            </div>
          </div>

          {/* Keyboard Shortcuts Help - Hidden on mobile */}
          {showKeyboardShortcuts && (
            <div className="hidden lg:flex bg-amber-50 border border-amber-200 rounded-lg p-3 text-xs text-amber-800 no-print items-center justify-between">
              <div>
                <strong>Keyboard Shortcuts:</strong>   Navigate | T Today | D Day | W Week | M Month | Y Year | S Schedule | P Print
              </div>
              <button
                onClick={() => setShowKeyboardShortcuts(false)}
                className="ml-4 p-1 hover:bg-amber-100 rounded transition-colors"
                title="Close"
              >
                <X className="w-4 h-4 text-amber-700" />
              </button>
            </div>
          )}

          {/* Print-Only Header */}
          <div className="calendar-print-header" style={{ display: 'none' }}>
            <div className="print-header">
              <div className="print-title">{user.businessName || 'Music Studio'} - Calendar</div>
              <div className="print-date">
                {view === 'month' 
                  ? currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
                  : currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
                } - {view.charAt(0).toUpperCase() + view.slice(1)} View
              </div>
            </div>
          </div>

          {/* Calendar Grid */}
          <div className="calendar-grid">
          {view === 'day' && (
            <DayView
              date={currentDate}
              lessons={filteredLessons}
              students={students}
              onTimeSlotClick={setShowAddLesson}
              onLessonClick={setSelectedLesson}
              onDragStart={handleDragStart}
              onDrop={handleDrop}
              hoveredLesson={hoveredLesson}
              setHoveredLesson={setHoveredLesson}
            />
          )}
          {view === 'week' && (
            <WeekView
              date={currentDate}
              lessons={filteredLessons}
              students={students}
              onTimeSlotClick={setShowAddLesson}
              onLessonClick={setSelectedLesson}
              onDragStart={handleDragStart}
              onDrop={handleDrop}
              hoveredLesson={hoveredLesson}
              setHoveredLesson={setHoveredLesson}
            />
          )}
          {view === 'month' && (
            <MonthView
              date={currentDate}
              lessons={filteredLessons}
              students={students}
              onLessonClick={setSelectedLesson}
              user={user}
              setLessons={setLessons}
              setStudents={setStudents}
            />
          )}
          {view === 'year' && (
            <YearView
              date={currentDate}
              lessons={filteredLessons}
              onDateClick={(newDate) => {
                setCurrentDate(newDate);
                setView('month');
              }}
            />
          )}
          </div>
          {view === 'schedule' && (
            <ScheduleListView
              user={user}
              students={students}
              lessons={filteredLessons}
              setLessons={setLessons}
              setSelectedLesson={setSelectedLesson}
              setShowRescheduleModal={setShowRescheduleModal}
            />
          )}

          {/* Hover Preview */}
          {hoveredLesson && (
            <div 
              className="fixed z-40 bg-stone-900 text-white p-4 rounded-lg shadow-2xl max-w-xs"
              style={{
                left: hoveredLesson.x + 10,
                top: hoveredLesson.y + 10,
                pointerEvents: 'none'
              }}
            >
              <div className="font-bold mb-1">{hoveredLesson.student?.name}</div>
              <div className="text-sm text-stone-300">{hoveredLesson.lesson.lessonType}</div>
              <div className="text-sm text-stone-300">{formatTime12Hour(hoveredLesson.lesson.time)}  {hoveredLesson.lesson.duration} min</div>
              <div className="text-sm text-stone-400 mt-1">${hoveredLesson.lesson.rate}</div>
              {hoveredLesson.lesson.sessionNumber && (
                <div className="text-xs text-amber-300 mt-1">
                  Session {hoveredLesson.lesson.sessionNumber}/{hoveredLesson.lesson.totalSessions}
                </div>
              )}
            </div>
          )}

          {/* Add Lesson Modal */}
          {showAddLesson && (
            <AddLessonModal
              slot={showAddLesson}
              students={students}
              lessonTypes={user.lessonTypes}
              onClose={() => setShowAddLesson(null)}
              onSave={(lesson) => {
                if (lesson.recurring) {
                  const dates = generateRecurringDates({
                    startDate: lesson.date,
                    frequency: lesson.recurringFrequency,
                    repeatDays: lesson.repeatDays,
                    endType: lesson.endType,
                    endDate: lesson.endDate,
                    count: lesson.recurringCount
                  });
                  const newLessons = dates.map((d, i) => ({
                    ...lesson,
                    id: Date.now() + i,
                    date: d,
                    recurring: undefined,
                    recurringCount: undefined,
                    recurringFrequency: undefined,
                    repeatDays: undefined,
                    endType: undefined,
                    endDate: undefined,
                    status: 'scheduled',
                    sessionNumber: i + 1,
                    totalSessions: dates.length
                  }));
                  setLessons([...lessons, ...newLessons]);
                } else {
                  setLessons([...lessons, { ...lesson, id: Date.now(), status: 'scheduled' }]);
                }
                setShowAddLesson(null);
              }}
              setStudents={setStudents}
            />
          )}

          {/* Lesson Detail Modal */}
          {selectedLesson && (
            <LessonDetailModal
              lesson={selectedLesson}
              student={students.find(s => s.id === selectedLesson.studentId)}
              lessonType={user.lessonTypes.find(t => t.name === selectedLesson.lessonType)}
              onClose={() => setSelectedLesson(null)}
              onUpdate={(updated) => {
                setLessons(lessons.map(l => l.id === updated.id ? updated : l));
                setSelectedLesson(null);
              }}
              onDelete={() => {
                if (confirm('Delete this lesson?')) {
                  setLessons(lessons.filter(l => l.id !== selectedLesson.id));
                  setSelectedLesson(null);
                }
              }}
              onReschedule={() => {
                setShowRescheduleModal(selectedLesson);
                setSelectedLesson(null);
              }}
            />
          )}

          {/* Reschedule Modal */}
          {showRescheduleModal && (
            <RescheduleModal
              lesson={showRescheduleModal}
              onClose={() => setShowRescheduleModal(null)}
              onSave={(updated) => {
                setLessons(lessons.map(l => l.id === updated.id ? updated : l));
                setShowRescheduleModal(null);
              }}
            />
          )}
        </div>
      );
    }

    // Day View Component
    function DayView({ date, lessons, students, onTimeSlotClick, onLessonClick, onDragStart, onDrop, hoveredLesson, setHoveredLesson }) {
      const hours = Array.from({ length: 24 }, (_, i) => i); // All 24 hours
      const dateStr = date.toISOString().split('T')[0];
      const now = new Date();
      const isToday = dateStr === now.toISOString().split('T')[0];
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      
      const getLessonsForHour = (hour) => {
        return lessons.filter(l => {
          if (l.date !== dateStr) return false;
          const lessonHour = parseInt(l.time.split(':')[0]);
          return lessonHour === hour;
        }).sort((a, b) => a.time.localeCompare(b.time)); // FIX: Sort by time
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDropOnSlot = (e, hour, quarter) => {
        e.preventDefault();
        const minutes = quarter * 15;
        const timeStr = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        onDrop(dateStr, timeStr);
      };

      return (
        <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden relative">
          {hours.map(hour => {
            const hourLessons = getLessonsForHour(hour);
            const timeStr = `${hour.toString().padStart(2, '0')}:00`;
            const isCurrentHour = isToday && currentHour === hour;

            return (
              <div key={hour} className="flex border-b border-stone-100 dark:border-stone-700 last:border-b-0 min-h-[60px] sm:min-h-[80px] relative">
                {/* Current time indicator */}
                {isCurrentHour && (
                  <div
                    className="absolute left-0 right-0 border-t-2 border-red-500 z-10"
                    style={{ top: `${(currentMinute / 60) * 80}px` }}
                  >
                    <div className="w-3 h-3 bg-red-500 rounded-full -mt-1.5 -ml-1.5"></div>
                  </div>
                )}

                <div className="w-14 sm:w-20 flex-shrink-0 p-2 sm:p-3 bg-stone-50 dark:bg-stone-900 border-r border-stone-200 dark:border-stone-700">
                  <span className="text-xs sm:text-sm font-medium text-stone-600 dark:text-stone-400">
                    {formatTime12Hour(timeStr)}
                  </span>
                </div>

                {/* Divided into 4 quarters for 15-min intervals */}
                <div className="flex-1 flex flex-col">
                  {[0, 1, 2, 3].map(quarter => {
                    const quarterMinutes = quarter * 15;
                    const quarterTime = `${hour.toString().padStart(2, '0')}:${quarterMinutes.toString().padStart(2, '0')}`;
                    
                    // Find lessons that start in this quarter
                    const quarterLessons = hourLessons.filter(l => l.time === quarterTime);
                    
                    return (
                      <div
                        key={quarter}
                        className="flex-1 p-2 relative"
                        onDragOver={handleDragOver}
                        onDrop={(e) => handleDropOnSlot(e, hour, quarter)}
                        style={{ minHeight: '20px' }}
                      >
                        {quarterLessons.length === 0 ? (
                          <button
                            onClick={() => onTimeSlotClick({ date: dateStr, time: quarterTime })}
                            className="w-full h-full hover:bg-teal-50 rounded transition-colors absolute inset-0"
                          />
                        ) : (
                          <div className="space-y-1">
                            {quarterLessons.map(lesson => (
                              <LessonBlock
                                key={lesson.id}
                                lesson={lesson}
                                student={students.find(s => s.id === lesson.studentId)}
                                onClick={() => onLessonClick(lesson)}
                                onDragStart={() => onDragStart(lesson)}
                                onHover={(e) => setHoveredLesson({
                                  lesson,
                                  student: students.find(s => s.id === lesson.studentId),
                                  x: e.clientX,
                                  y: e.clientY
                                })}
                                onHoverEnd={() => setHoveredLesson(null)}
                              />
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // Week View Component  
    function WeekView({ date, lessons, students, onTimeSlotClick, onLessonClick, onDragStart, onDrop, hoveredLesson, setHoveredLesson }) {
      const startOfWeek = new Date(date);
      startOfWeek.setDate(date.getDate() - date.getDay());
      
      const days = Array.from({ length: 7 }, (_, i) => {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        return day;
      });

      const hours = Array.from({ length: 24 }, (_, i) => i); // All 24 hours
      
      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDropOnSlot = (e, day, hour, quarter) => {
        e.preventDefault();
        const dateStr = day.toISOString().split('T')[0];
        const minutes = quarter * 15;
        const timeStr = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        onDrop(dateStr, timeStr);
      };

      return (
        <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden">
          <div className="overflow-x-auto">
          {/* Day Headers */}
          <div className="flex border-b border-stone-200 dark:border-stone-700 calendar-grid min-w-[600px]">
            <div className="w-14 sm:w-20 flex-shrink-0 bg-stone-50 dark:bg-stone-900" />
            {days.map(day => (
              <div key={day.toISOString()} className="flex-1 p-2 sm:p-3 text-center border-l border-stone-200 dark:border-stone-700 min-w-[70px]">
                <div className="text-xs font-medium text-stone-500 dark:text-stone-400">
                  {day.toLocaleDateString('en-US', { weekday: 'short' })}
                </div>
                <div className={`text-base sm:text-lg font-bold ${
                  day.toDateString() === new Date().toDateString() ? 'text-teal-700 dark:text-teal-400' : 'text-stone-900 dark:text-stone-100'
                }`}>
                  {day.getDate()}
                </div>
              </div>
            ))}
          </div>

          {/* Time Grid */}
          <div className="overflow-auto max-h-[600px] min-w-[600px]">
            {hours.map(hour => (
              <div key={hour} className="flex border-b border-stone-100 dark:border-stone-700 relative">
                <div className="w-14 sm:w-20 flex-shrink-0 p-1 sm:p-2 bg-stone-50 dark:bg-stone-900 border-r border-stone-200 dark:border-stone-700">
                  <span className="text-xs text-stone-600 dark:text-stone-400">
                    {formatTime12Hour(`${hour.toString().padStart(2, '0')}:00`)}
                  </span>
                </div>
                {days.map(day => {
                  const dateStr = day.toISOString().split('T')[0];
                  const now = new Date();
                  const isToday = dateStr === now.toISOString().split('T')[0];
                  const isCurrentHour = isToday && now.getHours() === hour;
                  const currentMinute = now.getMinutes();
                  
                  const dayLessons = lessons.filter(l => {
                    if (l.date !== dateStr) return false;
                    const lessonHour = parseInt(l.time.split(':')[0]);
                    return lessonHour === hour;
                  }).sort((a, b) => a.time.localeCompare(b.time));

                  return (
                    <div key={day.toISOString()} className="flex-1 border-l border-stone-200 dark:border-stone-700 relative flex flex-col">
                      {/* Current time indicator for today */}
                      {isCurrentHour && (
                        <div 
                          className="absolute left-0 right-0 border-t-2 border-red-500 z-10"
                          style={{ top: `${(currentMinute / 60) * 60}px` }}
                        >
                          <div className="w-2 h-2 bg-red-500 rounded-full -mt-1 -ml-1"></div>
                        </div>
                      )}
                      
                      {/* Divide into 4 quarters for 15-min intervals */}
                      {[0, 1, 2, 3].map(quarter => {
                        const quarterMinutes = quarter * 15;
                        const quarterTime = `${hour.toString().padStart(2, '0')}:${quarterMinutes.toString().padStart(2, '0')}`;
                        const quarterLessons = dayLessons.filter(l => l.time === quarterTime);
                        
                        return (
                          <div
                            key={quarter}
                            className="flex-1 p-1 relative"
                            onDragOver={handleDragOver}
                            onDrop={(e) => handleDropOnSlot(e, day, hour, quarter)}
                            style={{ minHeight: '15px' }}
                          >
                            {quarterLessons.length === 0 ? (
                              <button
                                onClick={() => onTimeSlotClick({ date: dateStr, time: quarterTime })}
                                className="w-full h-full hover:bg-teal-50 rounded transition-colors absolute inset-0"
                              />
                            ) : (
                              <div className="space-y-1">
                                {quarterLessons.map(lesson => (
                                  <LessonBlock
                                    key={lesson.id}
                                    lesson={lesson}
                                    student={students.find(s => s.id === lesson.studentId)}
                                    onClick={() => onLessonClick(lesson)}
                                    onDragStart={() => onDragStart(lesson)}
                                    onHover={(e) => setHoveredLesson({
                                      lesson,
                                      student: students.find(s => s.id === lesson.studentId),
                                      x: e.clientX,
                                      y: e.clientY
                                    })}
                                    onHoverEnd={() => setHoveredLesson(null)}
                                    compact
                                  />
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
          </div>
        </div>
      );
    }

    // Month View Component
    function MonthView({ date, lessons, students, onLessonClick, user, setLessons, setStudents }) {
      const [showDayPopup, setShowDayPopup] = useState(null); // {day, lessons}
      const [showAddLesson, setShowAddLesson] = useState(null); // {date, time}
      
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const days = [];
      for (let i = 0; i < startDay; i++) days.push(null);
      for (let i = 1; i <= daysInMonth; i++) days.push(i);

      const getLessonsForDay = (day) => {
        if (!day) return [];
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        return lessons
          .filter(l => l.date === dateStr)
          .sort((a, b) => a.time.localeCompare(b.time));
      };

      const getLessonColor = (lesson) => {
        if (lesson.status === 'completed') return 'bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-900/30 dark:text-green-400 dark:hover:bg-green-900/40';
        if (lesson.status === 'cancelled') return 'bg-red-100 text-red-800 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-400 dark:hover:bg-red-900/40';
        return 'bg-blue-100 text-blue-800 hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:hover:bg-blue-900/40';
      };
      
      const handleDayClick = (day) => {
        const dayLessons = getLessonsForDay(day);
        if (dayLessons.length === 0) {
          // Open schedule lesson modal with 7:00 AM default
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          setShowAddLesson({ date: dateStr, time: '07:00' });
        }
      };

      return (
        <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden">
          {/* Day Headers */}
          <div className="grid grid-cols-7 bg-stone-50 dark:bg-stone-700 border-b border-stone-200 dark:border-stone-700">
            {[['Sun','S'], ['Mon','M'], ['Tue','T'], ['Wed','W'], ['Thu','T'], ['Fri','F'], ['Sat','S']].map(([dayName, shortName], idx) => (
              <div
                key={dayName}
                className={`p-2 sm:p-3 text-center text-xs sm:text-sm font-medium text-stone-600 dark:text-stone-400 ${idx < 6 ? 'border-r border-stone-200 dark:border-stone-600' : ''}`}
              >
                <span className="hidden sm:inline">{dayName}</span>
                <span className="sm:hidden">{shortName}</span>
              </div>
            ))}
          </div>

          {/* Calendar Grid */}
          <div className="grid grid-cols-7">
            {days.map((day, idx) => {
              const dayLessons = getLessonsForDay(day);
              const isToday = day && new Date().getDate() === day && new Date().getMonth() === month && new Date().getFullYear() === year;
              const columnIndex = idx % 7;
              const maxVisible = window.innerWidth < 640 ? 1 : 3;

              return (
                <div
                  key={idx}
                  className={`min-h-[60px] sm:min-h-[120px] p-1 sm:p-2 border-b border-stone-200 dark:border-stone-700 ${columnIndex < 6 ? 'border-r border-stone-200 dark:border-stone-700' : ''} relative`}
                >
                  {day && (
                    <>
                      <div
                        className={`text-xs sm:text-sm font-medium mb-1 sm:mb-2 cursor-pointer hover:text-teal-600 dark:hover:text-teal-400 ${isToday ? 'text-teal-700 dark:text-teal-400 font-bold' : 'text-stone-700 dark:text-stone-300'}`}
                        onClick={() => handleDayClick(day)}
                      >
                        {day}
                      </div>
                      <div className="space-y-0.5 sm:space-y-1">
                        {/* On mobile: show dots; on desktop: show full lesson text */}
                        {dayLessons.slice(0, maxVisible).map(lesson => (
                          <button
                            key={lesson.id}
                            onClick={() => onLessonClick(lesson)}
                            className={`w-full text-left rounded text-xs transition-colors truncate ${getLessonColor(lesson)}`}
                          >
                            <span className="hidden sm:inline px-2 py-1 block">{formatTime12Hour(lesson.time)} - {students.find(s => s.id === lesson.studentId)?.name}</span>
                            <span className="sm:hidden block w-2 h-2 rounded-full mx-auto" style={{background: lesson.status === 'completed' ? '#16a34a' : lesson.status === 'cancelled' ? '#dc2626' : '#2563eb'}}></span>
                          </button>
                        ))}
                        {dayLessons.length > maxVisible && (
                          <button
                            onClick={() => setShowDayPopup({ day, lessons: dayLessons })}
                            className="text-xs text-teal-600 hover:text-teal-700 font-medium px-1 sm:px-2"
                          >
                            +{dayLessons.length - maxVisible}
                          </button>
                        )}
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
          
          {/* Day Lessons Popup */}
          {showDayPopup && (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4"
              onClick={() => setShowDayPopup(null)}
            >
              <div
                className="bg-white dark:bg-stone-800 rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold text-stone-900 dark:text-stone-100">
                    {date.toLocaleDateString('en-US', { month: 'long' })} {showDayPopup.day}, {year}
                  </h3>
                  <button
                    onClick={() => setShowDayPopup(null)}
                    className="p-2 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg transition-colors"
                  >
                    <X className="w-5 h-5 text-stone-600 dark:text-stone-400" />
                  </button>
                </div>
                
                <div className="space-y-2">
                  {showDayPopup.lessons.map(lesson => {
                    const student = students.find(s => s.id === lesson.studentId);
                    return (
                      <button
                        key={lesson.id}
                        onClick={() => {
                          setShowDayPopup(null);
                          onLessonClick(lesson);
                        }}
                        className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${getLessonColor(lesson)}`}
                      >
                        <div className="font-medium">{formatTime12Hour(lesson.time)} - {student?.name}</div>
                        <div className="text-xs mt-1 opacity-75">{lesson.lessonType}  {lesson.duration} min  ${lesson.rate}</div>
                      </button>
                    );
                  })}
                </div>
              </div>
            </div>
          )}
          
          {/* Add Lesson Modal */}
          {showAddLesson && (
            <AddLessonModal
              slot={showAddLesson}
              students={students}
              lessonTypes={user.lessonTypes}
              onClose={() => setShowAddLesson(null)}
              onSave={(lesson) => {
                if (lesson.recurring) {
                  const dates = generateRecurringDates({
                    startDate: lesson.date,
                    frequency: lesson.recurringFrequency,
                    repeatDays: lesson.repeatDays,
                    endType: lesson.endType,
                    endDate: lesson.endDate,
                    count: lesson.recurringCount
                  });
                  const newLessons = dates.map((d, i) => ({
                    ...lesson,
                    id: Date.now() + i,
                    date: d,
                    recurring: undefined,
                    recurringCount: undefined,
                    recurringFrequency: undefined,
                    repeatDays: undefined,
                    endType: undefined,
                    endDate: undefined,
                    status: 'scheduled',
                    sessionNumber: i + 1,
                    totalSessions: dates.length
                  }));
                  setLessons([...lessons, ...newLessons]);
                } else {
                  setLessons([...lessons, { ...lesson, id: Date.now(), status: 'scheduled' }]);
                }
                setShowAddLesson(null);
              }}
              setStudents={setStudents}
            />
          )}
        </div>
      );
    }

    // Year View Component
    function YearView({ date, lessons, onDateClick }) {
      const year = date.getFullYear();
      const months = Array.from({ length: 12 }, (_, i) => i);
      
      const getDaysInMonth = (month) => {
        return new Date(year, month + 1, 0).getDate();
      };
      
      const getLessonsForMonth = (month) => {
        return lessons.filter(l => {
          const lessonDate = new Date(l.date + 'T00:00:00');
          return lessonDate.getFullYear() === year && lessonDate.getMonth() === month;
        });
      };
      
      const handleMonthClick = (month) => {
        const newDate = new Date(year, month, 1);
        onDateClick(newDate);
      };
      
      return (
        <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden p-4 sm:p-6">
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 sm:gap-4">
            {months.map(month => {
              const monthLessons = getLessonsForMonth(month);
              const monthName = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'short' });

              return (
                <button
                  key={month}
                  onClick={() => handleMonthClick(month)}
                  className="p-3 sm:p-4 bg-stone-50 dark:bg-stone-700 hover:bg-teal-50 dark:hover:bg-teal-900/30 rounded-lg border border-stone-200 dark:border-stone-600 hover:border-teal-300 dark:hover:border-teal-600 transition-all"
                >
                  <div className="text-base sm:text-lg font-bold text-stone-900 dark:text-stone-100 mb-1">{monthName}</div>
                  <div className="text-sm text-stone-600 dark:text-stone-400">{monthLessons.length} lessons</div>
                  <div className="text-xs text-stone-500 dark:text-stone-400 mt-1">{getDaysInMonth(month)} days</div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    // Lesson Block Component
    function LessonBlock({ lesson, student, onClick, onDragStart, onHover, onHoverEnd, compact = false }) {
      const statusColors = {
        scheduled: 'bg-blue-100 border-blue-400 text-blue-900 dark:bg-blue-900/40 dark:border-blue-500 dark:text-blue-200',
        completed: 'bg-green-100 border-green-400 text-green-900 dark:bg-green-900/40 dark:border-green-500 dark:text-green-200',
        cancelled: 'bg-red-100 border-red-400 text-red-900 dark:bg-red-900/40 dark:border-red-500 dark:text-red-200',
      };

      return (
        <button
          onClick={onClick}
          draggable={lesson.status === 'scheduled'}
          onDragStart={() => onDragStart && onDragStart()}
          onMouseEnter={(e) => onHover && onHover(e)}
          onMouseMove={(e) => onHover && onHover(e)}
          onMouseLeave={() => onHoverEnd && onHoverEnd()}
          className={`w-full text-left px-3 py-2 rounded-lg border-2 transition-all hover:shadow-lg ${
            lesson.status === 'scheduled' ? 'cursor-move' : ''
          } ${statusColors[lesson.status] || statusColors.scheduled}`}
        >
          <div className="font-semibold text-sm">{formatTime12Hour(lesson.time)}</div>
          <div className={compact ? 'text-xs truncate' : 'text-sm font-medium'}>{student?.name}</div>
          {!compact && <div className="text-xs opacity-90">{lesson.lessonType}</div>}
        </button>
      );
    }

    // Add Lesson Modal Component (Google Calendar-style)
    function AddLessonModal({ slot, students, lessonTypes, onClose, onSave, setStudents }) {
      const [showAddStudent, setShowAddStudent] = useState(false);
      const [studentSearch, setStudentSearch] = useState('');
      const [showStudentDropdown, setShowStudentDropdown] = useState(false);
      const studentSearchRef = useRef(null);
      const dropdownRef = useRef(null);

      const initialDay = new Date(slot.date + 'T12:00:00').getDay();
      const [formData, setFormData] = useState({
        date: slot.date,
        time: slot.time,
        studentId: '',
        lessonType: lessonTypes[0]?.name || '',
        duration: lessonTypes[0]?.duration || 30,
        rate: lessonTypes[0]?.rate || 0,
        recurring: false,
        recurringFrequency: 'weekly',
        repeatDays: [initialDay],
        endType: 'after',
        endDate: '',
        recurringCount: 10,
      });

      // Close student dropdown on outside click
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (dropdownRef.current && !dropdownRef.current.contains(e.target) &&
              studentSearchRef.current && !studentSearchRef.current.contains(e.target)) {
            setShowStudentDropdown(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      // Update repeatDays when date changes
      useEffect(() => {
        if (formData.date) {
          const newDay = new Date(formData.date + 'T12:00:00').getDay();
          setFormData(prev => ({
            ...prev,
            repeatDays: prev.repeatDays.length === 1 && prev.repeatDays[0] === initialDay
              ? [newDay] : prev.repeatDays
          }));
        }
      }, [formData.date]);

      const filteredStudents = students.filter(s =>
        s.name.toLowerCase().includes(studentSearch.toLowerCase())
      );

      const selectedStudent = students.find(s => s.id === formData.studentId);

      const handleLessonTypeChange = (typeName) => {
        const type = lessonTypes.find(t => t.name === typeName);
        setFormData({ ...formData, lessonType: typeName, duration: type.duration, rate: type.rate });
      };

      const handleStudentSelect = (student) => {
        setStudentSearch(student.name);
        setShowStudentDropdown(false);
        if (student.customRate) {
          setFormData({ ...formData, studentId: student.id, rate: parseFloat(student.customRate) });
        } else {
          setFormData({ ...formData, studentId: student.id });
        }
      };

      const toggleRepeatDay = (day) => {
        setFormData(prev => {
          const days = prev.repeatDays.includes(day)
            ? prev.repeatDays.filter(d => d !== day)
            : [...prev.repeatDays, day].sort();
          return { ...prev, repeatDays: days.length > 0 ? days : [day] }; // at least one day
        });
      };

      // Compute preview count
      const previewCount = useMemo(() => {
        if (!formData.recurring || !formData.date) return 0;
        try {
          const dates = generateRecurringDates({
            startDate: formData.date,
            frequency: formData.recurringFrequency,
            repeatDays: formData.repeatDays,
            endType: formData.endType,
            endDate: formData.endDate,
            count: formData.recurringCount
          });
          return dates.length;
        } catch { return 0; }
      }, [formData.recurring, formData.date, formData.recurringFrequency, formData.repeatDays, formData.endType, formData.endDate, formData.recurringCount]);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.studentId) return;
        onSave(formData);
      };

      const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

      if (showAddStudent) {
        return (
          <AddStudentModal
            onClose={() => setShowAddStudent(false)}
            onSave={(student) => {
              const newId = Date.now();
              setStudents(prev => [...prev, { ...student, id: newId }]);
              setFormData({ ...formData, studentId: newId });
              setStudentSearch(student.name);
              setShowAddStudent(false);
            }}
            lessonTypes={lessonTypes}
          />
        );
      }

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4">
          <div className="bg-white dark:bg-stone-800 rounded-2xl p-4 sm:p-8 max-w-lg w-full animate-slide-up max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4 sm:mb-6">
              <h3 className="text-xl sm:text-2xl font-bold text-stone-900 dark:text-stone-100">Schedule Lesson</h3>
              <button onClick={onClose} className="p-2 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg">
                <X className="w-6 h-6 text-stone-600 dark:text-stone-400" />
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              {/* Student Search Autocomplete */}
              <div>
                <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Student *</label>
                {students.length === 0 ? (
                  <button
                    type="button"
                    onClick={() => setShowAddStudent(true)}
                    className="w-full px-4 py-3 border-2 border-dashed border-teal-300 dark:border-teal-600 text-teal-700 dark:text-teal-400 rounded-lg hover:bg-teal-50 dark:hover:bg-teal-900/20 transition-colors"
                  >
                    + Add Your First Student
                  </button>
                ) : (
                  <div className="relative">
                    <div className="flex gap-2">
                      <div className="flex-1 relative">
                        <input
                          ref={studentSearchRef}
                          type="text"
                          value={studentSearch}
                          onChange={(e) => {
                            setStudentSearch(e.target.value);
                            setShowStudentDropdown(true);
                            if (!e.target.value) setFormData({ ...formData, studentId: '' });
                          }}
                          onFocus={() => setShowStudentDropdown(true)}
                          onKeyDown={(e) => {
                            if (e.key === 'Escape') setShowStudentDropdown(false);
                          }}
                          placeholder="Search students..."
                          className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                          required={!formData.studentId}
                        />
                        {formData.studentId && (
                          <button
                            type="button"
                            onClick={() => { setStudentSearch(''); setFormData({ ...formData, studentId: '' }); }}
                            className="absolute right-3 top-1/2 -translate-y-1/2 text-stone-400 hover:text-stone-600 dark:hover:text-stone-300"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        )}
                      </div>
                      <button
                        type="button"
                        onClick={() => setShowAddStudent(true)}
                        className="px-4 py-2 border border-stone-200 dark:border-stone-600 text-stone-700 dark:text-stone-300 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700"
                      >
                        <Plus className="w-5 h-5" />
                      </button>
                    </div>

                    {/* Student Dropdown */}
                    {showStudentDropdown && !formData.studentId && (
                      <div ref={dropdownRef} className="absolute z-10 mt-1 w-full bg-white dark:bg-stone-700 border border-stone-200 dark:border-stone-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        {filteredStudents.length === 0 ? (
                          <div className="px-4 py-3 text-sm text-stone-500 dark:text-stone-400">No students found</div>
                        ) : (
                          filteredStudents.slice(0, 6).map(student => (
                            <button
                              key={student.id}
                              type="button"
                              onClick={() => handleStudentSelect(student)}
                              className="w-full text-left px-4 py-3 hover:bg-teal-50 dark:hover:bg-stone-600 transition-colors flex items-center justify-between"
                            >
                              <span className="text-sm font-medium text-stone-900 dark:text-stone-100">{student.name}</span>
                              {student.customRate && (
                                <span className="text-xs text-stone-500 dark:text-stone-400">${student.customRate}/lesson</span>
                              )}
                            </button>
                          ))
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Date & Time */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Date</label>
                  <input
                    type="date"
                    value={formData.date}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                    className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Time</label>
                  <input
                    type="time"
                    value={formData.time}
                    onChange={(e) => setFormData({ ...formData, time: e.target.value })}
                    className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                    required
                  />
                </div>
              </div>

              {/* Lesson Type */}
              <div>
                <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Lesson Type</label>
                <select
                  value={formData.lessonType}
                  onChange={(e) => handleLessonTypeChange(e.target.value)}
                  className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                >
                  {lessonTypes.map(type => (
                    <option key={type.name} value={type.name}>
                      {type.name} - {type.duration} min - ${type.rate}
                    </option>
                  ))}
                </select>
              </div>

              {/* Duration & Rate */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Duration (min)</label>
                  <input
                    type="number"
                    value={formData.duration}
                    onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) })}
                    className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Rate ($)</label>
                  <input
                    type="number"
                    value={formData.rate}
                    onChange={(e) => setFormData({ ...formData, rate: parseFloat(e.target.value) })}
                    className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  />
                </div>
              </div>

              {/* Recurring Section (Google Calendar-style) */}
              <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={formData.recurring}
                    onChange={(e) => setFormData({ ...formData, recurring: e.target.checked })}
                    className="w-5 h-5 accent-teal-700"
                  />
                  <span className="font-medium text-stone-900 dark:text-stone-100">Recurring Lesson</span>
                </label>

                {formData.recurring && (
                  <div className="mt-4 space-y-4">
                    {/* Frequency */}
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-1">Repeat</label>
                      <select
                        value={formData.recurringFrequency}
                        onChange={(e) => setFormData({ ...formData, recurringFrequency: e.target.value })}
                        className="w-full px-3 py-2 bg-white dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                      >
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Every 2 weeks</option>
                        <option value="monthly">Monthly</option>
                      </select>
                    </div>

                    {/* Repeat On - Day Buttons (weekly/biweekly only) */}
                    {(formData.recurringFrequency === 'weekly' || formData.recurringFrequency === 'biweekly') && (
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Repeat on</label>
                        <div className="flex gap-1.5 sm:gap-2">
                          {dayLabels.map((label, index) => (
                            <button
                              key={index}
                              type="button"
                              onClick={() => toggleRepeatDay(index)}
                              className={`w-9 h-9 sm:w-10 sm:h-10 rounded-full text-sm font-semibold transition-all ${
                                formData.repeatDays.includes(index)
                                  ? 'bg-teal-700 dark:bg-teal-600 text-white shadow-sm'
                                  : 'bg-white dark:bg-stone-600 text-stone-600 dark:text-stone-300 border border-stone-300 dark:border-stone-500 hover:border-teal-400 dark:hover:border-teal-500'
                              }`}
                            >
                              {label}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Ends Section */}
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Ends</label>
                      <div className="space-y-2">
                        {/* Never */}
                        <label className="flex items-center gap-3 cursor-pointer py-1">
                          <input
                            type="radio"
                            name="endType"
                            checked={formData.endType === 'never'}
                            onChange={() => setFormData({ ...formData, endType: 'never' })}
                            className="w-4 h-4 accent-teal-700"
                          />
                          <span className="text-sm text-stone-700 dark:text-stone-300">Never</span>
                        </label>

                        {/* On date */}
                        <label className="flex items-center gap-3 cursor-pointer py-1">
                          <input
                            type="radio"
                            name="endType"
                            checked={formData.endType === 'on'}
                            onChange={() => setFormData({ ...formData, endType: 'on' })}
                            className="w-4 h-4 accent-teal-700"
                          />
                          <span className="text-sm text-stone-700 dark:text-stone-300">On</span>
                          <input
                            type="date"
                            value={formData.endDate}
                            onChange={(e) => setFormData({ ...formData, endDate: e.target.value, endType: 'on' })}
                            onFocus={() => setFormData({ ...formData, endType: 'on' })}
                            min={formData.date}
                            className="flex-1 px-3 py-1.5 bg-white dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm"
                          />
                        </label>

                        {/* After N occurrences */}
                        <label className="flex items-center gap-3 cursor-pointer py-1">
                          <input
                            type="radio"
                            name="endType"
                            checked={formData.endType === 'after'}
                            onChange={() => setFormData({ ...formData, endType: 'after' })}
                            className="w-4 h-4 accent-teal-700"
                          />
                          <span className="text-sm text-stone-700 dark:text-stone-300">After</span>
                          <input
                            type="number"
                            min="1"
                            max="100"
                            value={formData.recurringCount}
                            onChange={(e) => setFormData({ ...formData, recurringCount: parseInt(e.target.value) || 1, endType: 'after' })}
                            onFocus={() => setFormData({ ...formData, endType: 'after' })}
                            className="w-20 px-3 py-1.5 bg-white dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm text-center"
                          />
                          <span className="text-sm text-stone-700 dark:text-stone-300">occurrences</span>
                        </label>
                      </div>
                    </div>

                    {/* Preview Count */}
                    {previewCount > 0 && (
                      <div className="flex items-center gap-2 pt-1 text-sm">
                        <Calendar className="w-4 h-4 text-teal-600 dark:text-teal-400" />
                        <span className="text-teal-700 dark:text-teal-400 font-medium">
                          Will create {previewCount} lesson{previewCount !== 1 ? 's' : ''}
                          {formData.endType === 'never' ? ' (max)' : ''}
                        </span>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Actions */}
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={onClose}
                  className="px-6 py-3 border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={!formData.studentId}
                  className="flex-1 py-3 bg-teal-700 dark:bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-600 dark:hover:bg-teal-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {formData.recurring ? `Schedule ${previewCount} Lesson${previewCount !== 1 ? 's' : ''}` : 'Schedule Lesson'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Lesson Detail Modal Component
    function LessonDetailModal({ lesson, student, lessonType, onClose, onUpdate, onDelete, onReschedule }) {
      const [isEditing, setIsEditing] = useState(false);
      const [notes, setNotes] = useState(lesson.notes || '');
      const [attendance, setAttendance] = useState(lesson.attendance || 'present');
      const [showNotesInput, setShowNotesInput] = useState(false);

      const handleStatusChange = (status) => {
        if (status === 'completed') {
          setShowNotesInput(true);
        } else {
          onUpdate({ ...lesson, status });
        }
      };

      const handleComplete = () => {
        onUpdate({ 
          ...lesson, 
          status: 'completed', 
          notes, 
          attendance,
          completedAt: new Date().toISOString() 
        });
      };

      // Format date properly
      const lessonDate = new Date(lesson.date + 'T00:00:00');
      const dayOfWeek = lessonDate.toLocaleDateString('en-US', { weekday: 'long' });
      const formattedDate = lessonDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4">
          <div className="bg-white dark:bg-stone-800 rounded-2xl p-4 sm:p-8 max-w-lg w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto animate-slide-up">
            <div className="flex items-center justify-between mb-4 sm:mb-6">
              <h3 className="text-xl sm:text-2xl font-bold text-stone-900 dark:text-stone-100">Lesson Details</h3>
              <button onClick={onClose} className="p-2 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg">
                <X className="w-6 h-6 text-stone-600 dark:text-stone-400" />
              </button>
            </div>

            {showNotesInput ? (
              <div className="space-y-4">
                <div className="bg-teal-50 dark:bg-teal-900/20 border border-teal-200 dark:border-teal-800 rounded-lg p-4">
                  <p className="text-sm text-teal-800 dark:text-teal-300 mb-2">Mark lesson as complete</p>
                  <p className="text-xs text-teal-600 dark:text-teal-400">Track attendance and add notes about this lesson</p>
                </div>

                {/* Attendance Toggle */}
                <div>
                  <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-3">Attendance</label>
                  <div className="flex gap-3">
                    <button
                      type="button"
                      onClick={() => setAttendance('present')}
                      className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                        attendance === 'present'
                          ? 'bg-green-500 text-white border-2 border-green-600'
                          : 'bg-white dark:bg-stone-700 border-2 border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-200 hover:border-green-400'
                      }`}
                    >
                      <div className="flex items-center justify-center gap-2">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Present
                      </div>
                    </button>
                    <button
                      type="button"
                      onClick={() => setAttendance('absent')}
                      className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                        attendance === 'absent'
                          ? 'bg-red-500 text-white border-2 border-red-600'
                          : 'bg-white dark:bg-stone-700 border-2 border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-200 hover:border-red-400'
                      }`}
                    >
                      <div className="flex items-center justify-center gap-2">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Absent
                      </div>
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Lesson Notes (optional)</label>
                  <textarea
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    placeholder="e.g., Student mastered C major scale. Homework: Practice arpeggios daily."
                    rows="5"
                    className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 placeholder-stone-400 dark:placeholder-stone-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 resize-none"
                  />
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowNotesInput(false)}
                    className="px-6 py-3 border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleComplete}
                    className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
                  >
                    Complete Lesson
                  </button>
                </div>
              </div>
            ) : (
              <>
                <div className="space-y-4 mb-6">
                  <div className="flex items-center justify-between pb-4 border-b border-stone-200 dark:border-stone-700">
                    <span className="text-sm text-stone-600 dark:text-stone-400">Status</span>
                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                      lesson.status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                      lesson.status === 'cancelled' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400' :
                      'bg-teal-100 text-teal-800 dark:bg-teal-900/30 dark:text-teal-400'
                    }`}>
                      {lesson.status}
                    </span>
                  </div>

                  <div className="space-y-3">
                    {lesson.sessionNumber && lesson.totalSessions && (
                      <div className="flex justify-between bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3">
                        <span className="text-sm font-medium text-amber-900 dark:text-amber-400">Session Progress</span>
                        <span className="text-sm font-bold text-amber-900 dark:text-amber-400">
                          {lesson.sessionNumber} of {lesson.totalSessions}
                        </span>
                      </div>
                    )}

                    {lesson.attendance && (
                      <div className={`flex justify-between rounded-lg p-3 border ${
                        lesson.attendance === 'present'
                          ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800'
                          : 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800'
                      }`}>
                        <span className="text-sm font-medium text-stone-700 dark:text-stone-300">Attendance</span>
                        <span className={`text-sm font-bold flex items-center gap-1 ${
                          lesson.attendance === 'present' ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'
                        }`}>
                          {lesson.attendance === 'present' ? (
                            <>
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                              </svg>
                              Present
                            </>
                          ) : (
                            <>
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                              </svg>
                              Absent
                            </>
                          )}
                        </span>
                      </div>
                    )}
                    <div className="flex justify-between">
                      <span className="text-stone-600 dark:text-stone-400">Student</span>
                      <span className="font-medium text-stone-900 dark:text-stone-100">{student?.name}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-stone-600 dark:text-stone-400">Date</span>
                      <span className="font-medium text-stone-900 dark:text-stone-100">{dayOfWeek}, {formattedDate}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-stone-600 dark:text-stone-400">Time</span>
                      <span className="font-medium text-stone-900 dark:text-stone-100">{lesson.time}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-stone-600 dark:text-stone-400">Type</span>
                      <span className="font-medium text-stone-900 dark:text-stone-100">{lesson.lessonType}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-stone-600 dark:text-stone-400">Duration</span>
                      <span className="font-medium text-stone-900 dark:text-stone-100">{lesson.duration} minutes</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-stone-600 dark:text-stone-400">Rate</span>
                      <span className="font-medium text-teal-700 dark:text-teal-400">${lesson.rate}</span>
                    </div>
                  </div>

                  {lesson.notes && (
                    <div className="bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 rounded-lg p-4">
                      <h4 className="text-sm font-semibold text-stone-900 dark:text-stone-100 mb-2">Lesson Notes</h4>
                      <p className="text-sm text-stone-700 dark:text-stone-300 whitespace-pre-wrap">{lesson.notes}</p>
                    </div>
                  )}

                  {lesson.completedAt && (
                    <div className="text-xs text-stone-500 dark:text-stone-400">
                      Completed: {new Date(lesson.completedAt).toLocaleString()}
                    </div>
                  )}
                </div>

                {lesson.status === 'scheduled' && (
                  <>
                    <div className="flex gap-3 pt-4 border-t border-stone-200 dark:border-stone-700 mb-3">
                      <button
                        onClick={() => handleStatusChange('completed')}
                        className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
                      >
                        Mark Complete
                      </button>
                      <button
                        onClick={() => handleStatusChange('cancelled')}
                        className="flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium"
                      >
                        Cancel
                      </button>
                    </div>
                    <button
                      onClick={onReschedule}
                      className="w-full py-3 border-2 border-amber-300 dark:border-amber-600 text-amber-700 dark:text-amber-400 rounded-lg hover:bg-amber-50 dark:hover:bg-amber-900/20 font-medium"
                    >
                      Reschedule Lesson
                    </button>
                  </>
                )}

                <button
                  onClick={onDelete}
                  className="w-full mt-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg"
                >
                  Delete Lesson
                </button>
              </>
            )}
          </div>
        </div>
      );
    }

    // Reschedule Modal Component
    function RescheduleModal({ lesson, onClose, onSave }) {
      const [newDate, setNewDate] = useState(lesson.date);
      const [newTime, setNewTime] = useState(lesson.time);

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ ...lesson, date: newDate, time: newTime });
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4">
          <div className="bg-white dark:bg-stone-800 rounded-2xl p-4 sm:p-8 max-w-md w-full animate-slide-up max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4 sm:mb-6">
              <h3 className="text-xl sm:text-2xl font-bold text-stone-900 dark:text-stone-100">Reschedule Lesson</h3>
              <button onClick={onClose} className="p-2 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg">
                <X className="w-6 h-6 text-stone-600 dark:text-stone-400" />
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4 mb-4">
                <p className="text-sm text-amber-800 dark:text-amber-400">
                  Current: {new Date(lesson.date + 'T00:00:00').toLocaleDateString()} at {lesson.time}
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">New Date</label>
                <input
                  type="date"
                  value={newDate}
                  onChange={(e) => setNewDate(e.target.value)}
                  className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">New Time</label>
                <input
                  type="time"
                  value={newTime}
                  onChange={(e) => setNewTime(e.target.value)}
                  className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                  required
                />
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={onClose}
                  className="px-6 py-3 border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="flex-1 py-3 bg-amber-600 text-white font-medium rounded-lg hover:bg-amber-700"
                >
                  Reschedule
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // Students View Component
    function StudentsView({ students, lessons, setStudents, user }) {
      const [showAddModal, setShowAddModal] = useState(false);
      const [editingStudent, setEditingStudent] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [viewMode, setViewMode] = useState('cards'); // 'cards' or 'list'
      const [viewingStudent, setViewingStudent] = useState(null); // NEW - for profile view

      const handleEdit = (student) => {
        setEditingStudent(student);
        setShowAddModal(true);
      };

      const handleDelete = (id) => {
        if (confirm('Are you sure you want to delete this student?')) {
          setStudents(students.filter(s => s.id !== id));
        }
      };
      
      const handleViewProfile = (student) => {
        setViewingStudent(student);
      };

      // Filter students by search
      const filteredStudents = students.filter(student => {
        if (!searchQuery) return true;
        const searchLower = searchQuery.toLowerCase();
        return (
          student.name.toLowerCase().includes(searchLower) ||
          student.email.toLowerCase().includes(searchLower) ||
          (student.parentName && student.parentName.toLowerCase().includes(searchLower))
        );
      });

      return (
        <div className="animate-fade-in space-y-4 sm:space-y-6">
          {/* Students Header - Row 1: Title + Search */}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pb-4 border-b border-stone-200 dark:border-stone-700">
            <h2 className="text-2xl sm:text-3xl font-bold text-stone-900 dark:text-stone-100">Students</h2>
            <div className="relative">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search students..."
                className="pl-10 pr-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 placeholder-stone-400 dark:placeholder-stone-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 w-full sm:w-80 transition-colors"
              />
              <svg className="w-5 h-5 text-stone-400 dark:text-stone-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
              </svg>
            </div>
          </div>

          {/* Students Header - Row 2: Add Student (Left) + View Dropdown + Print/Export (Right) */}
          <div className="flex flex-wrap items-center gap-2 sm:gap-3">
            <button
              onClick={() => {
                setEditingStudent(null);
                setShowAddModal(true);
              }}
              className="flex items-center gap-2 px-3 sm:px-4 py-2 bg-teal-700 dark:bg-teal-600 text-white rounded-lg hover:bg-teal-600 dark:hover:bg-teal-500 transition-colors text-sm sm:text-base"
            >
              <Plus className="w-5 h-5" />
              Add Student
            </button>

            {/* Right: View Dropdown + Print/Export */}
            <div className="flex items-center gap-2 ml-auto">
              {/* View Dropdown */}
              <div className="relative">
                <select
                  value={viewMode}
                  onChange={(e) => setViewMode(e.target.value)}
                  className="appearance-none px-3 sm:px-4 py-2 pr-8 sm:pr-10 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400"
                >
                  <option value="cards">Cards</option>
                  <option value="list">List</option>
                </select>
                <ChevronDown className="w-4 h-4 text-stone-500 dark:text-stone-400 absolute right-2 sm:right-3 top-1/2 -translate-y-1/2 pointer-events-none" />
              </div>

              {/* Print Button */}
              <button
                onClick={() => window.print()}
                className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors hidden sm:block"
                title="Print"
              >
                <svg className="w-5 h-5 text-stone-600 dark:text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
                </svg>
              </button>

              {/* Export Button */}
              <button
                onClick={() => {
                  let exportText = `Students - ${user.businessName || 'Music Studio'}\n\n`;
                  filteredStudents.forEach(student => {
                    exportText += `${student.name}\n`;
                    exportText += `Email: ${student.isMinor ? student.parentEmail : student.email}\n`;
                    if (student.phone) exportText += `Phone: ${student.isMinor ? student.parentPhone : student.phone}\n`;
                    exportText += `\n`;
                  });
                  const blob = new Blob([exportText], { type: 'text/plain' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'students-list.txt';
                  a.click();
                  URL.revokeObjectURL(url);
                }}
                className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors hidden sm:block"
                title="Export"
              >
                <svg className="w-5 h-5 text-stone-600 dark:text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
                </svg>
              </button>
            </div>
          </div>

          {filteredStudents.length === 0 ? (
            <div className="bg-white dark:bg-stone-800 rounded-xl p-12 border border-stone-200 dark:border-stone-700 text-center transition-colors">
              <Users className="w-16 h-16 text-stone-300 dark:text-stone-600 mx-auto mb-4" />
              <h3 className="text-xl font-bold text-stone-900 dark:text-stone-100 mb-2">
                {students.length === 0 ? 'No students yet' : 'No students found'}
              </h3>
              <p className="text-stone-600 dark:text-stone-400 mb-6">
                {students.length === 0 
                  ? 'Add your first student to get started scheduling lessons.'
                  : 'Try adjusting your search to find students.'
                }
              </p>
              {students.length === 0 && (
                <button
                  onClick={() => setShowAddModal(true)}
                  className="inline-flex items-center gap-2 px-6 py-3 bg-teal-700 dark:bg-teal-600 text-white rounded-lg hover:bg-teal-600 dark:hover:bg-teal-500 transition-colors"
                >
                  <Plus className="w-5 h-5" />
                  Add Your First Student
                </button>
              )}
            </div>
          ) : viewMode === 'cards' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredStudents.map(student => (
                <StudentCard
                  key={student.id}
                  student={student}
                  lessons={lessons}
                  onEdit={handleEdit}
                  onDelete={handleDelete}
                  onViewProfile={handleViewProfile}
                  lessonTypes={user.lessonTypes}
                />
              ))}
            </div>
          ) : (
            <StudentListView
              students={filteredStudents}
              lessons={lessons}
              onEdit={handleEdit}
              onDelete={handleDelete}
              onViewProfile={handleViewProfile}
            />
          )}

          {/* Student Profile View Modal */}
          {viewingStudent && (
            <StudentProfileView
              student={viewingStudent}
              lessons={lessons}
              onClose={() => setViewingStudent(null)}
              onEdit={(student) => {
                setViewingStudent(null);
                setEditingStudent(student);
                setShowAddModal(true);
              }}
              lessonTypes={user.lessonTypes}
            />
          )}

          {/* Add/Edit Student Modal */}
          {showAddModal && (
            <AddStudentModal
              student={editingStudent}
              onClose={() => {
                setShowAddModal(false);
                setEditingStudent(null);
              }}
              onSave={(student) => {
                if (editingStudent) {
                  setStudents(students.map(s => s.id === student.id ? student : s));
                } else {
                  setStudents([...students, { ...student, id: Date.now() }]);
                }
                setShowAddModal(false);
                setEditingStudent(null);
              }}
              lessonTypes={user.lessonTypes}
            />
          )}
        </div>
      );
    }

    // Student List View Component
    function StudentListView({ students, lessons, onEdit, onDelete, onViewProfile }) {
      // Get upcoming lesson for a student
      const getUpcomingLesson = (studentId) => {
        const now = new Date();
        return lessons
          .filter(l => l.studentId === studentId && l.status === 'scheduled')
          .filter(l => {
            const lessonDateTime = new Date(l.date + 'T' + l.time);
            return lessonDateTime >= now;
          })
          .sort((a, b) => {
            const dateA = new Date(a.date + 'T' + a.time);
            const dateB = new Date(b.date + 'T' + b.time);
            return dateA - dateB;
          })[0];
      };
      
      // Count total lessons for a student
      const getTotalLessons = (studentId) => {
        return lessons.filter(l => l.studentId === studentId).length;
      };
      
      // Format upcoming lesson
      const formatUpcomingLesson = (lesson) => {
        if (!lesson) return 'No upcoming lessons';
        const lessonDate = new Date(lesson.date + 'T00:00:00');
        const dayName = lessonDate.toLocaleDateString('en-US', { weekday: 'short' });
        const monthName = lessonDate.toLocaleDateString('en-US', { month: 'short' });
        const day = lessonDate.getDate();
        const time = formatTime12Hour(lesson.time);
        return `${dayName}, ${monthName} ${day}, ${time}`;
      };
      
      return (
        <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden transition-colors overflow-x-auto">
          <table className="w-full min-w-[700px]">
            <thead className="bg-stone-50 dark:bg-stone-900/50 border-b border-stone-200 dark:border-stone-700">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-stone-500 dark:text-stone-400 uppercase tracking-wider">Name</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-stone-500 dark:text-stone-400 uppercase tracking-wider">Email</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-stone-500 dark:text-stone-400 uppercase tracking-wider">Phone</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-stone-500 dark:text-stone-400 uppercase tracking-wider">Upcoming Lesson</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-stone-500 dark:text-stone-400 uppercase tracking-wider">Total Lessons</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-stone-500 dark:text-stone-400 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-stone-200 dark:divide-stone-700">
              {students.map(student => {
                const upcomingLesson = getUpcomingLesson(student.id);
                const totalLessons = getTotalLessons(student.id);
                
                return (
                  <tr 
                    key={student.id} 
                    className="hover:bg-stone-50 dark:hover:bg-stone-700/50 transition-colors cursor-pointer"
                    onClick={() => onViewProfile(student)}
                  >
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div>
                        <div className="text-sm font-medium text-stone-900 dark:text-stone-100">{student.name}</div>
                        {student.isMinor && student.parentName && (
                          <div className="text-xs text-stone-500 dark:text-stone-400">Parent: {student.parentName}</div>
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-stone-600 dark:text-stone-400">
                      {student.isMinor ? student.parentEmail : student.email}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-stone-600 dark:text-stone-400">
                      {student.isMinor ? student.parentPhone : student.phone || ''}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`text-sm ${upcomingLesson ? 'text-teal-700 dark:text-teal-400 font-medium' : 'text-stone-400 dark:text-stone-500'}`}>
                        {formatUpcomingLesson(upcomingLesson)}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 dark:bg-teal-900/30 text-teal-800 dark:text-teal-400">
                        {totalLessons} {totalLessons === 1 ? 'lesson' : 'lessons'}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <div className="flex items-center justify-end gap-2">
                        <button
                          onClick={(e) => { e.stopPropagation(); onEdit(student); }}
                          className="p-2 text-stone-600 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg transition-colors"
                          title="Edit"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); onDelete(student.id); }}
                          className="p-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                          title="Delete"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      );
    }

    // Student Profile View Component (Read-Only)
    function StudentProfileView({ student, lessons, onClose, onEdit, lessonTypes }) {
      const upcomingLessons = lessons
        .filter(l => l.studentId === student.id && l.status === 'scheduled')
        .filter(l => new Date(l.date + 'T' + l.time) >= new Date())
        .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
        .slice(0, 5);
        
      const completedLessons = lessons
        .filter(l => l.studentId === student.id && l.status === 'completed')
        .length;
        
      const totalRevenue = lessons
        .filter(l => l.studentId === student.id && l.status === 'completed')
        .reduce((sum, l) => sum + (l.rate || 0), 0);

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={onClose}>
          <div 
            className="bg-white dark:bg-stone-800 rounded-2xl w-full max-w-4xl max-h-[95vh] sm:max-h-[90vh] flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >
            {/* FIXED HEADER */}
            <div className="flex items-center justify-between p-4 sm:p-6 border-b border-stone-200 dark:border-stone-700">
              <div className="flex items-center gap-3 sm:gap-4">
                {student.profileImage && (
                  <img
                    src={student.profileImage}
                    alt={student.name}
                    className="w-12 h-12 sm:w-16 sm:h-16 rounded-full object-cover border-2 border-stone-200 dark:border-stone-600"
                    onError={(e) => e.target.style.display = 'none'}
                  />
                )}
                <div>
                  <h3 className="text-xl sm:text-2xl font-bold text-stone-900 dark:text-stone-100">{student.name}</h3>
                  {student.isMinor && student.parentName && (
                    <p className="text-sm text-stone-500 dark:text-stone-400">Parent: {student.parentName}</p>
                  )}
                </div>
              </div>
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => onEdit(student)}
                  className="px-4 py-2 bg-teal-700 dark:bg-teal-600 text-white rounded-lg hover:bg-teal-600 dark:hover:bg-teal-500 transition-colors"
                >
                  Edit Profile
                </button>
                <button onClick={onClose} className="p-2 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg">
                  <X className="w-6 h-6 text-stone-600 dark:text-stone-400" />
                </button>
              </div>
            </div>

            {/* SCROLLABLE CONTENT */}
            <div className="overflow-y-auto p-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Left Column */}
                <div className="space-y-6">
                  {/* Contact Information */}
                  <div className="bg-stone-50 dark:bg-stone-900 p-4 rounded-lg border border-stone-200 dark:border-stone-700">
                    <h4 className="font-semibold text-stone-900 dark:text-stone-100 mb-3">Contact Information</h4>
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-stone-500 dark:text-stone-400">Email:</span>
                        <span className="ml-2 text-stone-900 dark:text-stone-100">{student.isMinor ? student.parentEmail : student.email}</span>
                      </div>
                      {(student.phone || student.parentPhone) && (
                        <div>
                          <span className="text-stone-500 dark:text-stone-400">Phone:</span>
                          <span className="ml-2 text-stone-900 dark:text-stone-100">{student.isMinor ? student.parentPhone : student.phone}</span>
                        </div>
                      )}
                      {student.dateOfBirth && (
                        <div>
                          <span className="text-stone-500 dark:text-stone-400">Date of Birth:</span>
                          <span className="ml-2 text-stone-900 dark:text-stone-100">{new Date(student.dateOfBirth + 'T00:00').toLocaleDateString()}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Address */}
                  {((student.isMinor && student.parentAddressLine1) || (!student.isMinor && student.addressLine1)) && (
                    <div className="bg-stone-50 dark:bg-stone-900 p-4 rounded-lg border border-stone-200 dark:border-stone-700">
                      <h4 className="font-semibold text-stone-900 dark:text-stone-100 mb-3">Address</h4>
                      <div className="text-sm text-stone-900 dark:text-stone-100">
                        {student.isMinor ? (
                          <>
                            <p>{student.parentAddressLine1}</p>
                            {student.parentAddressLine2 && <p>{student.parentAddressLine2}</p>}
                            <p>{student.parentCity}, {student.parentState} {student.parentZipCode}</p>
                          </>
                        ) : (
                          <>
                            <p>{student.addressLine1}</p>
                            {student.addressLine2 && <p>{student.addressLine2}</p>}
                            <p>{student.city}, {student.state} {student.zipCode}</p>
                          </>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Emergency Contact */}
                  {student.emergencyContactName && (
                    <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-800">
                      <h4 className="font-semibold text-stone-900 dark:text-stone-100 mb-3">Emergency Contact</h4>
                      <div className="space-y-2 text-sm">
                        <div>
                          <span className="text-stone-500 dark:text-stone-400">Name:</span>
                          <span className="ml-2 text-stone-900 dark:text-stone-100">{student.emergencyContactName}</span>
                        </div>
                        {student.emergencyContactPhone && (
                          <div>
                            <span className="text-stone-500 dark:text-stone-400">Phone:</span>
                            <span className="ml-2 text-stone-900 dark:text-stone-100">{student.emergencyContactPhone}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Lesson Preferences */}
                  <div className="bg-teal-50 dark:bg-teal-900/20 p-4 rounded-lg border border-teal-200 dark:border-teal-800">
                    <h4 className="font-semibold text-stone-900 dark:text-stone-100 mb-3">Lesson Preferences</h4>
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-stone-500 dark:text-stone-400">Type:</span>
                        <span className="ml-2 text-stone-900 dark:text-stone-100">{student.defaultLessonType}</span>
                      </div>
                      {student.customRate && (
                        <div>
                          <span className="text-stone-500 dark:text-stone-400">Custom Rate:</span>
                          <span className="ml-2 text-stone-900 dark:text-stone-100">${student.customRate}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Right Column - Stats & Lessons */}
                <div className="space-y-6">
                  {/* Stats Cards */}
                  <div className="grid grid-cols-3 gap-3">
                    <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-center border border-blue-200 dark:border-blue-800">
                      <div className="text-2xl font-bold text-blue-700 dark:text-blue-400">
                        {upcomingLessons.length}
                      </div>
                      <div className="text-xs text-stone-600 dark:text-stone-400">Upcoming</div>
                    </div>
                    <div className="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg text-center border border-green-200 dark:border-green-800">
                      <div className="text-2xl font-bold text-green-700 dark:text-green-400">
                        {completedLessons}
                      </div>
                      <div className="text-xs text-stone-600 dark:text-stone-400">Completed</div>
                    </div>
                    <div className="bg-teal-50 dark:bg-teal-900/20 p-3 rounded-lg text-center border border-teal-200 dark:border-teal-800">
                      <div className="text-2xl font-bold text-teal-700 dark:text-teal-400">
                        ${totalRevenue.toFixed(0)}
                      </div>
                      <div className="text-xs text-stone-600 dark:text-stone-400">Revenue</div>
                    </div>
                  </div>

                  {/* Upcoming Lessons */}
                  <div className="bg-stone-50 dark:bg-stone-900 p-4 rounded-lg border border-stone-200 dark:border-stone-700">
                    <h4 className="font-semibold text-stone-900 dark:text-stone-100 mb-3">Upcoming Lessons</h4>
                    {upcomingLessons.length === 0 ? (
                      <p className="text-sm text-stone-500 dark:text-stone-400">No upcoming lessons</p>
                    ) : (
                      <div className="space-y-2">
                        {upcomingLessons.map(lesson => (
                          <div 
                            key={lesson.id}
                            className="flex justify-between items-center p-2 bg-white dark:bg-stone-800 rounded border border-stone-200 dark:border-stone-700"
                          >
                            <div className="text-sm">
                              <div className="font-medium text-stone-900 dark:text-stone-100">
                                {new Date(lesson.date + 'T00:00').toLocaleDateString('en-US', { 
                                  weekday: 'short', 
                                  month: 'short', 
                                  day: 'numeric' 
                                })}
                              </div>
                              <div className="text-xs text-stone-500 dark:text-stone-400">
                                {formatTime12Hour(lesson.time)}  {lesson.lessonType}
                              </div>
                            </div>
                            <div className="text-sm font-bold text-teal-700 dark:text-teal-400">
                              ${lesson.rate}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Student Card Component
    function StudentCard({ student, lessons, onEdit, onDelete, onViewProfile, lessonTypes }) {
      const defaultType = lessonTypes.find(t => t.name === student.defaultLessonType);
      
      // Find next upcoming lesson for this student
      const now = new Date();
      const upcomingLesson = lessons
        .filter(l => l.studentId === student.id && l.status === 'scheduled')
        .filter(l => {
          const lessonDateTime = new Date(l.date + 'T' + l.time);
          return lessonDateTime >= now;
        })
        .sort((a, b) => {
          const dateA = new Date(a.date + 'T' + a.time);
          const dateB = new Date(b.date + 'T' + b.time);
          return dateA - dateB;
        })[0];
      
      // Format upcoming lesson date
      const formatUpcomingLesson = (lesson) => {
        if (!lesson) return null;
        const lessonDate = new Date(lesson.date + 'T00:00:00');
        const dayName = lessonDate.toLocaleDateString('en-US', { weekday: 'long' });
        const monthName = lessonDate.toLocaleDateString('en-US', { month: 'long' });
        const day = lessonDate.getDate();
        const year = lessonDate.getFullYear();
        const time = formatTime12Hour(lesson.time);
        return `${dayName}, ${monthName} ${day}, ${year}, ${time}`;
      };
      
      return (
        <div 
          className="bg-white dark:bg-stone-800 rounded-xl p-6 border border-stone-200 dark:border-stone-700 hover:shadow-md transition-all cursor-pointer"
          onClick={() => onViewProfile(student)}
        >
          <div className="flex items-start justify-between mb-4">
            <div>
              <h3 className="text-lg font-bold text-stone-900 dark:text-stone-100">{student.name}</h3>
              {student.isMinor && student.parentName && (
                <p className="text-sm text-stone-500 dark:text-stone-400">Parent: {student.parentName}</p>
              )}
            </div>
            <div className="flex gap-2">
              <button
                onClick={(e) => { e.stopPropagation(); onEdit(student); }}
                className="p-2 text-stone-600 dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-stone-700 rounded-lg transition-colors"
                title="Edit"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button
                onClick={(e) => { e.stopPropagation(); onDelete(student.id); }}
                className="p-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                title="Delete"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>

          <div className="space-y-2">
            <div className="flex items-center gap-2 text-sm text-stone-600 dark:text-stone-400">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              <span className="truncate">{student.isMinor ? student.parentEmail : student.email}</span>
            </div>
            {student.phone && (
              <div className="flex items-center gap-2 text-sm text-stone-600 dark:text-stone-400">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>{student.isMinor ? student.parentPhone : student.phone}</span>
              </div>
            )}
            {upcomingLesson ? (
              <div className="flex items-start gap-2 pt-3 border-t border-stone-100 dark:border-stone-700">
                <div className="flex-1">
                  <span className="text-xs font-medium text-stone-500 dark:text-stone-400 block mb-1">Upcoming Lesson</span>
                  <span className="text-xs text-teal-700 dark:text-teal-400 font-medium">{formatUpcomingLesson(upcomingLesson)}</span>
                </div>
              </div>
            ) : (
              <div className="pt-3 border-t border-stone-100 dark:border-stone-700">
                <span className="text-xs text-stone-400 dark:text-stone-500">No upcoming lessons</span>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Add Student Modal Component
    function AddStudentModal({ student, onClose, onSave, lessonTypes }) {
      const [formData, setFormData] = useState(student || {
        // Student Info
        name: '',
        email: '',
        phone: '',
        dateOfBirth: '',
        profileImage: '',
        addressLine1: '',
        addressLine2: '',
        city: '',
        state: '',
        zipCode: '',
        
        // Minor flag
        isMinor: false,
        
        // Parent Info
        parentName: '',
        parentEmail: '',
        parentPhone: '',
        parentDateOfBirth: '',
        parentAddressLine1: '',
        parentAddressLine2: '',
        parentCity: '',
        parentState: '',
        parentZipCode: '',
        
        // Emergency Contact
        emergencyContactName: '',
        emergencyContactPhone: '',
        
        // Lesson Preferences
        defaultLessonType: lessonTypes[0]?.name || '',
        customRate: '',
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={onClose}>
          <div 
            className="bg-white dark:bg-stone-800 rounded-2xl w-full max-w-4xl max-h-[95vh] sm:max-h-[90vh] flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >
            {/* FIXED HEADER */}
            <div className="flex items-center justify-between p-4 sm:p-6 border-b border-stone-200 dark:border-stone-700 flex-shrink-0">
              <h3 className="text-xl sm:text-2xl font-bold text-stone-900 dark:text-stone-100">
                {student ? 'Edit Student' : 'Add New Student'}
              </h3>
              <button onClick={onClose} className="p-2 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg transition-colors">
                <X className="w-6 h-6 text-stone-600 dark:text-stone-400" />
              </button>
            </div>

            {/* SCROLLABLE CONTENT */}
            <div className="overflow-y-auto flex-1 p-4 sm:p-6">
              <form id="student-form" onSubmit={handleSubmit} className="space-y-6">
                {/* Student Information Section */}
                <div className="space-y-4">
                  <h4 className="text-lg font-semibold text-stone-900 dark:text-stone-100 pb-2 border-b border-stone-200 dark:border-stone-700">
                    Student Information
                  </h4>
                  
                  {/* Profile Image Preview + URL */}
                  <div className="flex items-start gap-4">
                    {formData.profileImage && (
                      <img 
                        src={formData.profileImage} 
                        alt="Profile preview" 
                        className="w-20 h-20 rounded-full object-cover border-2 border-stone-200 dark:border-stone-600 flex-shrink-0"
                        onError={(e) => e.target.style.display = 'none'}
                      />
                    )}
                    <div className="flex-1">
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Profile Image URL (optional)
                      </label>
                      <input
                        type="url"
                        value={formData.profileImage}
                        onChange={(e) => setFormData({ ...formData, profileImage: e.target.value })}
                        placeholder="https://example.com/image.jpg"
                        className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                      />
                      <p className="mt-1 text-xs text-stone-500 dark:text-stone-400">Enter URL to see preview above</p>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {/* Student Name (full width) */}
                    <div className="md:col-span-3">
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Student Name <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        required
                      />
                    </div>
                    
                    {/* Student Email */}
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Student Email {!formData.isMinor && <span className="text-red-500">*</span>}
                      </label>
                      <input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        required={!formData.isMinor}
                      />
                    </div>
                    
                    {/* Student Phone */}
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Student Phone
                      </label>
                      <input
                        type="tel"
                        value={formData.phone}
                        onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                        className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                      />
                    </div>
                    
                    {/* Date of Birth */}
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Date of Birth
                      </label>
                      <input
                        type="date"
                        value={formData.dateOfBirth}
                        onChange={(e) => setFormData({ ...formData, dateOfBirth: e.target.value })}
                        className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                      />
                    </div>
                    
                    {/* Student Address (only if 18+) */}
                    {!formData.isMinor && (
                      <>
                        <div className="md:col-span-3">
                          <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                            Address Line 1
                          </label>
                          <input
                            type="text"
                            value={formData.addressLine1}
                            onChange={(e) => setFormData({ ...formData, addressLine1: e.target.value })}
                            placeholder="123 Main Street"
                            className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                          />
                        </div>
                        
                        <div className="md:col-span-3">
                          <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                            Address Line 2
                          </label>
                          <input
                            type="text"
                            value={formData.addressLine2}
                            onChange={(e) => setFormData({ ...formData, addressLine2: e.target.value })}
                            placeholder="Apt, Suite, Unit (optional)"
                            className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                            City
                          </label>
                          <input
                            type="text"
                            value={formData.city}
                            onChange={(e) => setFormData({ ...formData, city: e.target.value })}
                            className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                            State
                          </label>
                          <input
                            type="text"
                            value={formData.state}
                            onChange={(e) => setFormData({ ...formData, state: e.target.value.toUpperCase() })}
                            placeholder="TX"
                            maxLength="2"
                            className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors uppercase"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                            ZIP Code
                          </label>
                          <input
                            type="text"
                            value={formData.zipCode}
                            onChange={(e) => setFormData({ ...formData, zipCode: e.target.value })}
                            placeholder="75189"
                            maxLength="10"
                            className="w-full px-4 py-3 bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                          />
                        </div>
                      </>
                    )}
                  </div>
                </div>

                {/* Under 18 Checkbox */}
                <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
                  <label className="flex items-center gap-3 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={formData.isMinor}
                      onChange={(e) => setFormData({ ...formData, isMinor: e.target.checked })}
                      className="w-5 h-5 accent-teal-700"
                    />
                    <span className="font-medium text-stone-900 dark:text-stone-100">
                      This student is under 18 (requires parent/guardian info)
                    </span>
                  </label>
                </div>

                {/* Parent/Guardian Information (conditional) */}
                {formData.isMinor && (
                  <div className="space-y-4 bg-stone-50 dark:bg-stone-900/50 p-6 rounded-lg border border-stone-200 dark:border-stone-700">
                    <h4 className="text-lg font-semibold text-stone-900 dark:text-stone-100 pb-2 border-b border-stone-200 dark:border-stone-700">
                      Primary Parent/Guardian Information
                    </h4>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {/* Parent Name */}
                      <div className="md:col-span-3">
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          Parent/Guardian Name <span className="text-red-500">*</span>
                        </label>
                        <input
                          type="text"
                          value={formData.parentName}
                          onChange={(e) => setFormData({ ...formData, parentName: e.target.value })}
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                          required={formData.isMinor}
                        />
                      </div>
                      
                      {/* Parent Email */}
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          Parent Email <span className="text-red-500">*</span>
                        </label>
                        <input
                          type="email"
                          value={formData.parentEmail}
                          onChange={(e) => setFormData({ ...formData, parentEmail: e.target.value })}
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                          required={formData.isMinor}
                        />
                        <p className="mt-1 text-xs text-stone-500 dark:text-stone-400">All emails sent to parent</p>
                      </div>
                      
                      {/* Parent Phone */}
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          Parent Phone
                        </label>
                        <input
                          type="tel"
                          value={formData.parentPhone}
                          onChange={(e) => setFormData({ ...formData, parentPhone: e.target.value })}
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                      
                      {/* Parent Date of Birth */}
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          Parent Date of Birth
                        </label>
                        <input
                          type="date"
                          value={formData.parentDateOfBirth}
                          onChange={(e) => setFormData({ ...formData, parentDateOfBirth: e.target.value })}
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                      
                      {/* Parent Address */}
                      <div className="md:col-span-3">
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          Address Line 1
                        </label>
                        <input
                          type="text"
                          value={formData.parentAddressLine1}
                          onChange={(e) => setFormData({ ...formData, parentAddressLine1: e.target.value })}
                          placeholder="123 Main Street"
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                      
                      <div className="md:col-span-3">
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          Address Line 2
                        </label>
                        <input
                          type="text"
                          value={formData.parentAddressLine2}
                          onChange={(e) => setFormData({ ...formData, parentAddressLine2: e.target.value })}
                          placeholder="Apt, Suite, Unit (optional)"
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          City
                        </label>
                        <input
                          type="text"
                          value={formData.parentCity}
                          onChange={(e) => setFormData({ ...formData, parentCity: e.target.value })}
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          State
                        </label>
                        <input
                          type="text"
                          value={formData.parentState}
                          onChange={(e) => setFormData({ ...formData, parentState: e.target.value.toUpperCase() })}
                          placeholder="TX"
                          maxLength="2"
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors uppercase"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                          ZIP Code
                        </label>
                        <input
                          type="text"
                          value={formData.parentZipCode}
                          onChange={(e) => setFormData({ ...formData, parentZipCode: e.target.value })}
                          placeholder="75189"
                          maxLength="10"
                          className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                    </div>
                  </div>
                )}

                {/* Emergency Contact Section */}
                <div className="bg-red-50 dark:bg-red-900/20 p-6 rounded-lg border border-red-200 dark:border-red-800">
                  <h4 className="text-lg font-semibold text-stone-900 dark:text-stone-100 pb-2 border-b border-red-200 dark:border-red-800 mb-4">
                    Emergency Contact
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Emergency Contact Name
                      </label>
                      <input
                        type="text"
                        value={formData.emergencyContactName}
                        onChange={(e) => setFormData({ ...formData, emergencyContactName: e.target.value })}
                        placeholder="Alternative contact person"
                        className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Emergency Contact Phone
                      </label>
                      <input
                        type="tel"
                        value={formData.emergencyContactPhone}
                        onChange={(e) => setFormData({ ...formData, emergencyContactPhone: e.target.value })}
                        className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                      />
                    </div>
                  </div>
                  <p className="mt-2 text-xs text-stone-500 dark:text-stone-400">Person to contact if parent/guardian is unavailable</p>
                </div>

                {/* Lesson Preferences */}
                <div className="bg-teal-50 dark:bg-teal-900/20 p-6 rounded-lg border border-teal-200 dark:border-teal-800">
                  <h4 className="text-lg font-semibold text-stone-900 dark:text-stone-100 pb-2 border-b border-teal-200 dark:border-teal-800 mb-4">
                    Lesson Preferences
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Default Lesson Type
                      </label>
                      <select
                        value={formData.defaultLessonType}
                        onChange={(e) => setFormData({ ...formData, defaultLessonType: e.target.value })}
                        className="w-full px-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                      >
                        {lessonTypes.map(type => (
                          <option key={type.name} value={type.name}>
                            {type.name} - ${type.rate}/{type.duration}min
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">
                        Custom Rate (optional)
                      </label>
                      <div className="relative">
                        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-500 dark:text-stone-400">$</span>
                        <input
                          type="number"
                          value={formData.customRate}
                          onChange={(e) => setFormData({ ...formData, customRate: e.target.value })}
                          placeholder={lessonTypes.find(t => t.name === formData.defaultLessonType)?.rate || ''}
                          className="w-full pl-8 pr-4 py-3 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors"
                        />
                      </div>
                      <p className="mt-1 text-xs text-stone-500 dark:text-stone-400">For scholarships or special pricing</p>
                    </div>
                  </div>
                </div>
              </form>
            </div>

            {/* STICKY FOOTER */}
            <div className="p-4 sm:p-6 border-t border-stone-200 dark:border-stone-700 bg-white dark:bg-stone-800 flex-shrink-0">
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={onClose}
                  className="px-6 py-3 border border-stone-300 dark:border-stone-600 text-stone-700 dark:text-stone-300 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  form="student-form"
                  className="flex-1 py-3 bg-teal-700 dark:bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-600 dark:hover:bg-teal-500 transition-colors"
                >
                  {student ? 'Update Student' : 'Add Student'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Billing View Component
    function BillingView({ lessons, students }) {
      const [searchQuery, setSearchQuery] = useState('');
      const [viewMode, setViewMode] = useState('summary'); // 'summary' or 'transactions'
      
      const completedLessons = lessons.filter(l => l.status === 'completed');
      const scheduledLessons = lessons.filter(l => l.status === 'scheduled');
      
      const totalEarned = completedLessons.reduce((sum, l) => sum + (l.rate || 0), 0);
      const totalPending = scheduledLessons.reduce((sum, l) => sum + (l.rate || 0), 0);

      const studentRevenue = students.map(student => {
        const studentLessons = completedLessons.filter(l => l.studentId === student.id);
        const total = studentLessons.reduce((sum, l) => sum + (l.rate || 0), 0);
        return { student, total, count: studentLessons.length };
      }).filter(s => s.count > 0).sort((a, b) => b.total - a.total);

      // Filter student revenue by search
      const filteredRevenue = studentRevenue.filter(item => {
        if (!searchQuery) return true;
        return item.student.name.toLowerCase().includes(searchQuery.toLowerCase());
      });

      // Filter recent lessons by search
      const filteredRecentLessons = completedLessons
        .filter(lesson => {
          if (!searchQuery) return true;
          const student = students.find(s => s.id === lesson.studentId);
          return student?.name.toLowerCase().includes(searchQuery.toLowerCase());
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);
      
      // Export function
      const handleExport = () => {
        let exportText = `Billing Report\n\n`;
        exportText += `Total Earned: $${totalEarned.toFixed(2)}\n`;
        exportText += `Scheduled Revenue: $${totalPending.toFixed(2)}\n`;
        exportText += `Total Potential: $${(totalEarned + totalPending).toFixed(2)}\n\n`;
        exportText += `Revenue by Student:\n`;
        studentRevenue.forEach(({ student, total, count }) => {
          exportText += `${student.name}: $${total.toFixed(2)} (${count} lessons)\n`;
        });
        
        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'billing-report.txt';
        a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div className="animate-fade-in space-y-4 sm:space-y-6">
          {/* Billing Header - Row 1: Title + Search */}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pb-4 border-b border-stone-200 dark:border-stone-700">
            <h2 className="text-2xl sm:text-3xl font-bold text-stone-900 dark:text-stone-100">Billing</h2>
            <div className="relative">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search by student..."
                className="pl-10 pr-4 py-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 text-stone-900 dark:text-stone-100 placeholder-stone-400 dark:placeholder-stone-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 w-full sm:w-80 transition-colors"
              />
              <svg className="w-5 h-5 text-stone-400 dark:text-stone-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
              </svg>
            </div>
          </div>

          {/* Billing Header - Row 2: View Dropdown + Print/Export (Right) */}
          <div className="flex items-center justify-end">
            {/* Right: View Dropdown + Print/Export */}
            <div className="flex items-center gap-2">
              {/* View Dropdown */}
              <div className="relative">
                <select
                  value={viewMode}
                  onChange={(e) => setViewMode(e.target.value)}
                  className="appearance-none px-3 sm:px-4 py-2 pr-8 sm:pr-10 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg text-sm font-medium text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400"
                >
                  <option value="summary">Summary</option>
                  <option value="transactions">Transactions</option>
                </select>
                <ChevronDown className="w-4 h-4 text-stone-500 dark:text-stone-400 absolute right-2 sm:right-3 top-1/2 -translate-y-1/2 pointer-events-none" />
              </div>

              {/* Print Button */}
              <button
                onClick={() => window.print()}
                className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors hidden sm:block"
                title="Print"
              >
                <svg className="w-5 h-5 text-stone-600 dark:text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
                </svg>
              </button>

              {/* Export Button */}
              <button
                onClick={handleExport}
                className="p-2 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-600 rounded-lg hover:bg-stone-50 dark:hover:bg-stone-700 transition-colors hidden sm:block"
                title="Export"
              >
                <svg className="w-5 h-5 text-stone-600 dark:text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2"/>
                </svg>
              </button>
            </div>
          </div>

          {/* Revenue Cards */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-white dark:bg-stone-800 rounded-xl p-6 border border-stone-200 dark:border-stone-700 transition-colors">
              <div className="flex items-center gap-3 mb-2">
                <div className="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                  <CheckCircle className="w-6 h-6 text-green-700 dark:text-green-400" />
                </div>
                <span className="text-sm font-medium text-stone-600 dark:text-stone-400">Total Earned</span>
              </div>
              <div className="text-3xl font-bold text-stone-900 dark:text-stone-100">${totalEarned.toFixed(2)}</div>
              <div className="text-sm text-stone-500 dark:text-stone-400 mt-1">{completedLessons.length} lessons completed</div>
            </div>

            <div className="bg-white dark:bg-stone-800 rounded-xl p-6 border border-stone-200 dark:border-stone-700 transition-colors">
              <div className="flex items-center gap-3 mb-2">
                <div className="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center">
                  <Calendar className="w-6 h-6 text-amber-700 dark:text-amber-400" />
                </div>
                <span className="text-sm font-medium text-stone-600 dark:text-stone-400">Scheduled Revenue</span>
              </div>
              <div className="text-3xl font-bold text-stone-900 dark:text-stone-100">${totalPending.toFixed(2)}</div>
              <div className="text-sm text-stone-500 dark:text-stone-400 mt-1">{scheduledLessons.length} upcoming lessons</div>
            </div>

            <div className="bg-white dark:bg-stone-800 rounded-xl p-6 border border-stone-200 dark:border-stone-700 transition-colors">
              <div className="flex items-center gap-3 mb-2">
                <div className="w-10 h-10 bg-teal-100 dark:bg-teal-900/30 rounded-lg flex items-center justify-center">
                  <DollarSign className="w-6 h-6 text-teal-700 dark:text-teal-400" />
                </div>
                <span className="text-sm font-medium text-stone-600 dark:text-stone-400">Total Potential</span>
              </div>
              <div className="text-3xl font-bold text-stone-900 dark:text-stone-100">${(totalEarned + totalPending).toFixed(2)}</div>
              <div className="text-sm text-stone-500 dark:text-stone-400 mt-1">All lessons</div>
            </div>
          </div>

          {/* Revenue by Student */}
          <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden transition-colors">
            <div className="px-4 sm:px-6 py-4 border-b border-stone-200 dark:border-stone-700">
              <h3 className="text-lg font-bold text-stone-900 dark:text-stone-100">Revenue by Student</h3>
            </div>

            {filteredRevenue.length === 0 ? (
              <div className="p-8 sm:p-12 text-center">
                <DollarSign className="w-16 h-16 text-stone-300 dark:text-stone-600 mx-auto mb-4" />
                <p className="text-stone-600 dark:text-stone-400">
                  {studentRevenue.length === 0 ? 'No completed lessons yet' : 'No students found'}
                </p>
              </div>
            ) : (
              <div className="divide-y divide-stone-100 dark:divide-stone-700">
                {filteredRevenue.map(({ student, total, count }) => (
                  <div key={student.id} className="px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between hover:bg-stone-50 dark:hover:bg-stone-700/50 transition-colors">
                    <div className="min-w-0 flex-1 mr-3">
                      <div className="font-medium text-stone-900 dark:text-stone-100 truncate">{student.name}</div>
                      <div className="text-sm text-stone-500 dark:text-stone-400">{count} lessons completed</div>
                    </div>
                    <div className="text-right flex-shrink-0">
                      <div className="text-base sm:text-lg font-bold text-teal-700 dark:text-teal-400">${total.toFixed(2)}</div>
                      <div className="text-xs sm:text-sm text-stone-500 dark:text-stone-400">${(total / count).toFixed(2)}/avg</div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Recent Completed Lessons */}
          <div className="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 overflow-hidden transition-colors">
            <div className="px-4 sm:px-6 py-4 border-b border-stone-200 dark:border-stone-700">
              <h3 className="text-lg font-bold text-stone-900 dark:text-stone-100">Recent Completed Lessons</h3>
            </div>

            {filteredRecentLessons.length === 0 ? (
              <div className="p-8 sm:p-12 text-center">
                <CheckCircle className="w-16 h-16 text-stone-300 dark:text-stone-600 mx-auto mb-4" />
                <p className="text-stone-600 dark:text-stone-400">
                  {completedLessons.length === 0 ? 'No completed lessons yet' : 'No lessons found'}
                </p>
              </div>
            ) : (
              <div className="divide-y divide-stone-100 dark:divide-stone-700">
                {filteredRecentLessons.map(lesson => {
                  const student = students.find(s => s.id === lesson.studentId);
                  return (
                    <div key={lesson.id} className="px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between hover:bg-stone-50 dark:hover:bg-stone-700/50 transition-colors">
                      <div className="min-w-0 flex-1 mr-3">
                        <div className="font-medium text-stone-900 dark:text-stone-100 truncate">{student?.name}</div>
                        <div className="text-xs sm:text-sm text-stone-500 dark:text-stone-400">
                          {new Date(lesson.date + 'T00:00:00').toLocaleDateString()} at {formatTime12Hour(lesson.time)}  {lesson.lessonType}
                        </div>
                      </div>
                      <div className="text-right flex-shrink-0">
                        <div className="font-bold text-green-700 dark:text-green-400">${lesson.rate}</div>
                        <div className="text-xs text-stone-500 dark:text-stone-400">{lesson.duration} min</div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    }

    // Render the app
    try {
      const root = createRoot(document.getElementById('root'));
      root.render(<CadenceApp />);
    } catch (error) {
      document.getElementById('loading').innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; text-align: left;">
          <h1 style="color: #dc2626; margin-bottom: 1rem;">Error Loading App</h1>
          <p style="margin-bottom: 0.5rem;"><strong>Error:</strong> ${error.message}</p>
          <pre style="background: #fee; padding: 1rem; border-radius: 0.5rem; overflow: auto; font-size: 0.75rem;">${error.stack}</pre>
        </div>
      `;
    }
  </script>
</body>
</html>
